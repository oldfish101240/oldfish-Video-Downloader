<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>oldfish影片下載器</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script>
        // 初始化 Qt WebChannel 並建立與後端的橋接，提供 window.pywebview.api 相容層
        (function(){
            function initChannel(){
                if (typeof QWebChannel === 'undefined' || !window.qt || !qt.webChannelTransport){
                    // 若尚未就緒，稍後重試
                    return setTimeout(initChannel, 50);
                }
                new QWebChannel(qt.webChannelTransport, function(channel){
                    window.api = channel.objects.api;
                    window.pywebview = { api: window.api };
                    
                    // 初始化回調管理器
                    console.log('[前端] 初始化回調管理器');
                    window.__videoInfoCallback = null;
                    window.__videoInfoErrorCallback = null;
                    
                    // 設置全局回調，作為後備處理
                    window.__onVideoInfo = function(info) {
                        console.log('[前端] __onVideoInfo 被調用', info);
                        console.log('[前端] 當前回調函數:', window.__videoInfoCallback ? '已設置' : '未設置');
                        
                        if (window.__videoInfoCallback && typeof window.__videoInfoCallback === 'function') {
                            console.log('[前端] 使用專用回調處理');
                            try {
                                window.__videoInfoCallback(info);
                            } catch (e) {
                                console.error('[前端] 專用回調執行出錯:', e);
                            }
                        } else {
                            console.warn('[前端] 沒有專用回調，使用默認處理');
                            // 如果沒有專用回調，嘗試根據資訊類型處理
                            if (info && info.is_playlist) {
                                console.log('[前端] 檢測到播放清單資訊，但沒有專用回調');
                            }
                        }
                    };
                    
                    window.__onVideoInfoError = function(error) {
                        console.error('[前端] __onVideoInfoError 被調用:', error);
                        if (window.__videoInfoErrorCallback && typeof window.__videoInfoErrorCallback === 'function') {
                            try {
                                window.__videoInfoErrorCallback(error);
                            } catch (e) {
                                console.error('[前端] 錯誤回調執行出錯:', e);
                            }
                        }
                    };
                    
                    console.log('[前端] 回調管理器初始化完成');
                });
            }
            initChannel();
        })();
    </script>
    <style>
        :root {
            --ease-default: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --ease-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transition: all 0.25s var(--ease-default);
        }
        
        /* 基本動畫關鍵幀 */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #181a20;
            color: #e5e7eb;
            transition: background 0.3s ease, color 0.3s ease;
        }
        /* 全域卷軸樣式（Chromium/QtWebEngine） */
        html, body, .main, .queue-list {
            scrollbar-width: thin; /* Firefox 後備 */
            scrollbar-color: #4a4f59 #121418; /* 拇指/軌道：現代灰 */
        }
        ::-webkit-scrollbar {
            width: 8px;  /* 更纖細 */
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #121418; /* 深色軌道 */
        }
        ::-webkit-scrollbar-thumb {
            background: #3a3f4a; /* 中性深灰 */
            border-radius: 6px;
            border: 2px solid #121418; /* 與軌道留縫，視覺更輕 */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4a4f59; /* 略亮的灰色，避免過亮 */
            border-color: #121418;
        }
        ::-webkit-scrollbar-corner {
            background: #121418;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 160px;
            background: #23262f;
            box-shadow: 2px 0 8px #111;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding-top: 20px;
            transition: width 0.3s var(--ease-smooth);
            overflow: hidden;
        }
        .sidebar.collapsed {
            width: 60px;
        }
        .sidebar .menu-btn {
            margin-bottom: 30px;
            cursor: pointer;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 6px;
            transition: transform 0.3s ease;
        }
        .sidebar.collapsed .menu-btn img {
            transform: rotate(180deg);
        }
        .sidebar .nav-item {
            width: 100%;
            height: 48px;
            margin-bottom: 6px; /* 標籤間距縮短 */
            display: flex;
            align-items: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s var(--ease-smooth);
            padding-left: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .sidebar .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        
        .sidebar .nav-item:hover::before {
            left: 100%;
        }
        
        .sidebar .nav-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .sidebar .nav-item.selected {
            background: #2ecc71;
            box-shadow: 0 0 6px #27ae60;
        }
        .sidebar .nav-item img {
            width: 28px;
            height: 28px;
            filter: brightness(0.85);
        }
        .sidebar .nav-text {
            margin-left: 16px;
            font-size: 17px;
            font-weight: 500;
            transition: opacity 0.2s ease-in-out 0.05s;
            opacity: 1;
            color: #e5e7eb;
            white-space: nowrap;
        }
        .sidebar.collapsed .nav-text {
            opacity: 0;
            transition: opacity 0.1s ease-in-out
        }
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            overflow-y: auto; /* 讓主內容可滾動，配合 sticky 底部區 */
        }
        .title-img {
            margin-top: 60px;
            margin-bottom: 30px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 540px;
            filter: drop-shadow(0 0 8px #222);
        }
        .search-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 40px;
        }
        .search-input {
            width: 340px;
            height: 38px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #23262f;
            color: #e5e7eb;
            padding: 0 14px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s var(--ease-smooth);
            position: relative;
        }
        
        .search-input::placeholder {
            transition: opacity 0.3s ease;
        }
        
        .search-input:focus::placeholder {
            opacity: 0.7;
        }
        .search-input:focus {
            border-color: #2ecc71;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.3);
        }
        .download-btn {
            margin-left: 12px;
            background: #27ae60;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0 24px;
            height: 38px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s var(--ease-spring);
            box-shadow: 0 2px 8px #111;
            position: relative;
            overflow: hidden;
        }
        
        .download-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .download-btn:active::before {
            width: 300px;
            height: 300px;
        }
        .download-btn:hover {
            background: #219150;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }
        
        .download-btn:active {
            transform: scale(0.98) translateY(0);
            animation: none;
        }
        
        .settings-btn {
            position: fixed;
            right: 24px;
            bottom: 24px;
            width: 56px;
            height: 56px;
            background: #2ecc71;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(46, 204, 113, 0.3);
            transition: all 0.3s var(--ease-smooth);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-btn:hover {
            background: #27ae60;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }
        .settings-btn img {
            width: 28px;
            height: 28px;
            filter: brightness(0) invert(1);
        }
        

        .hidden {
            display: none;
        }
        .queue-page {
            /* margin-top: 100px; */ /* 移除此行，由 queue-list 內部控制間距 */
            text-align: center;
            font-size: 22px;
            color: #888;
            flex: 1; /* 讓佇列頁面佔據剩餘空間 */
            width: 100%; /* 讓佇列頁面寬度為100% */
            display: flex; /* 讓其內容可以居中 */
            flex-direction: column;
            align-items: center;
            justify-content: space-between; /* 上下分佈，讓底部輸入區靠底 */
        }
        .modal-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.35);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .modal-bg.show {
            display: flex;
            opacity: 1;
            transform: scale(1);
            animation: scaleIn 0.3s var(--ease-spring);
        }
        .modal {
            background: #23262f;
            border-radius: 16px;
            box-shadow: 0 4px 24px #000a;
            padding: 28px 32px 24px 32px;
            min-width: 320px;
            max-width: 90vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .modal-icon {
            position: absolute;
            left: 24px;
            top: 24px;
            width: 32px;
            height: 32px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #2ecc71;
            margin-bottom: 18px;
            margin-top: 0;
            width: 100%;
            text-align: center;
        }
        .modal-msg {
            font-size: 16px;
            color: #e5e7eb;
            margin-bottom: 18px;
            text-align: center;
            width: 100%;
            white-space: pre-line;
        }
        .modal-btn {
            background: #27ae60;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0 24px;
            height: 38px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 8px;
            align-self: center;
        }
        .modal-btn:hover {
            background: #219150;
        }
        
        /* 確認對話框按鈕樣式 */
        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            justify-content: center;
        }
        
        .modal-btn-primary {
            background: #27ae60;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0 24px;
            height: 38px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal-btn-primary:hover {
            background: #219150;
        }
        
        .modal-btn-secondary {
            background: #6c757d;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0 24px;
            height: 38px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal-btn-secondary:hover {
            background: #5a6268;
        }
        .video-modal-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.35);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .video-modal-bg.show {
            display: flex;
            opacity: 1;
            transform: scale(1);
        }
        .video-modal {
            background: #23262f;
            border-radius: 16px;
            box-shadow: 0 4px 24px #000a;
            padding: 0;
            min-width: 450px;
            max-width: 90vw;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            position: relative;
        }
        .video-modal-loading {
            padding: 24px;
            font-size: 16px;
            color: #aaa;
            text-align: center;
        }
        .video-modal-header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #444;
        }
        .video-modal-thumb {
            width: 160px;
            height: 120px;
            border-radius: 8px;
            object-fit: contain;
            margin-right: 16px;
            background: #181a20;
            flex-shrink: 0;
        }
        .video-modal-titlebox {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
        }
        .video-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 6px;
            margin-top: 0;
            word-break: break-word;
            line-height: 1.3;
        }
        .video-modal-meta {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 0;
        }
        .video-modal-uploader {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 0;
        }
        .video-modal-options {
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-bottom: 1px solid #444;
        }
        .video-modal-label {
            font-size: 13px;
            color: #e5e7eb;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .video-modal-options-wrapper {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }
        .video-modal-option-item {
            width: 100%;
        }
        .custom-select {
            position: relative;
            width: 100%;
            max-width: 300px;
            user-select: none;
        }
        .custom-select-header {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #1a1d23;
            color: #e5e7eb;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }
        .custom-select-text{
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }
        .custom-select-header:hover {
            border-color: #2ecc71;
            background: #2b2e37;
        }
        .custom-select-header.active {
            border-color: #2ecc71;
            background: #2b2e37;
            box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.2);
        }
        .custom-select-arrow {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #e5e7eb;
            transition: transform 0.2s ease;
        }
        .custom-select-header.active .custom-select-arrow {
            transform: rotate(180deg);
        }
        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #23262f;
            border: 1px solid #444;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .custom-select-options.show {
            display: block;
        }
        .custom-select-option {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #333;
            font-size: 14px;
        }
        .custom-select-option:last-child {
            border-bottom: none;
        }
        .custom-select-option:hover {
            background: #2ecc71;
            color: #fff;
        }
        .custom-select-option.selected {
            background: #2ecc71;
            color: #fff;
        }



        /* 淺色主題樣式 */
        body.light-theme {
            background: #f5f5f5;
            color: #333;
        }
        /* 淺色主題的卷軸顏色 */
        body.light-theme, body.light-theme .main, body.light-theme .queue-list {
            scrollbar-color: #b5b8bd #ededed; /* 淺色主題灰 */
        }
        body.light-theme ::-webkit-scrollbar-track {
            background: #ededed;
        }
        body.light-theme ::-webkit-scrollbar-thumb {
            background: #c7cad0; /* 中灰 */
            border-color: #ededed;
            border-radius: 6px;
        }
        body.light-theme ::-webkit-scrollbar-thumb:hover {
            background: #b5b8bd; /* 稍深灰 */
        }
        body.light-theme .container {
            background: #f5f5f5;
        }
        body.light-theme .sidebar {
            background: #ffffff;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }
        body.light-theme .nav-item {
            color: #333;
        }
        body.light-theme .nav-item.selected {
            background: #2ecc71;
            color: #fff;
        }
        body.light-theme .nav-text {
            color: #333;
        }
        body.light-theme .nav-item.selected .nav-text {
            color: #fff;
        }
        body.light-theme .main {
            background: #f5f5f5;
        }

        body.light-theme .search-input {
            background: #ffffff;
            border-color: #ddd;
            color: #333;
        }
        body.light-theme .search-input:focus {
            border-color: #2ecc71;
        }
        body.light-theme .queue-item {
            background: #ffffff;
            color: #333;
        }
        body.light-theme .custom-select-header {
            background: #ffffff;
            border-color: #ddd;
            color: #333;
        }
        body.light-theme .custom-select-options {
            background: #ffffff;
            border-color: #ddd;
        }
        body.light-theme .custom-select-option {
            color: #333;
            border-bottom-color: #eee;
        }
        body.light-theme .modal {
            background: #ffffff;
            color: #333;
        }
        body.light-theme .video-modal {
            background: #ffffff;
            color: #333;
        }
        body.light-theme .video-modal-title {
            color: #333;
        }
        body.light-theme .video-modal-label {
            color: #333;
        }
        .video-modal-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
        }
        .video-modal-btn {
            background: #27ae60;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 24px;
            font-size: 15px;
            height: 40px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
            white-space: nowrap;
            min-width: 100px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .video-modal-btn.cancel {
            background: #444;
            color: #eee;
        }
        .video-modal-btn:hover {
            background: #219150;
        }
        .video-modal-btn.cancel:hover {
            background: #666;
        }

        /* 播放清單選擇模態視窗樣式 */
        .playlist-modal-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .playlist-modal-bg.show {
            opacity: 1;
        }
        .playlist-modal {
            background: #23262f;
            border-radius: 16px;
            width: 90%;
            max-width: 1000px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            border: 1px solid #444;
            overflow: hidden;
        }
        .playlist-modal-header {
            padding: 12px 20px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .playlist-modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #e5e7eb;
        }
        .playlist-modal-subtitle {
            font-size: 12px;
            color: #aaa;
            margin-top: 2px;
        }
        .playlist-modal-close {
            background: transparent;
            border: none;
            color: #e5e7eb;
            font-size: 28px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .playlist-modal-close:hover {
            background: #2b2e37;
        }
        .playlist-modal-toolbar {
            padding: 8px 20px;
            border-bottom: 1px solid #444;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
            flex-wrap: wrap;
        }
        .playlist-toolbar-btn {
            background: #2b2e37;
            color: #e5e7eb;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .playlist-toolbar-btn:hover {
            background: #2ecc71;
            border-color: #2ecc71;
            color: #fff;
        }
        .playlist-toolbar-check {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #e5e7eb;
            font-size: 13px;
            user-select: none;
            padding: 6px 10px;
            border: 1px solid #444;
            background: #2b2e37;
            border-radius: 6px;
            white-space: nowrap;
        }
        .playlist-toolbar-check input[type="checkbox"]{
            width: 16px;
            height: 16px;
            accent-color: #2ecc71;
        }
        .playlist-toolbar-select {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 6px 10px;
            border: 1px solid #444;
            background: #2b2e37;
            border-radius: 6px;
        }
        .playlist-toolbar-select .playlist-toolbar-select-label{
            color:#aaa;
            font-size:12px;
            white-space: nowrap;
        }
        .playlist-toolbar-select .custom-select{
            max-width: none;
            width: 220px;
        }
        .playlist-toolbar-select .custom-select-header{
            padding: 6px 10px;
            font-size: 12px;
        }
        .custom-select.disabled .custom-select-header{
            opacity: 0.55;
            cursor: not-allowed;
            border-color: #444;
            background: #1f222a;
            box-shadow: none;
        }
        .custom-select.disabled .custom-select-arrow{
            opacity: 0.4;
        }
        .custom-select.error {
            animation: shake 0.5s;
        }
        .custom-select.error .custom-select-header {
            border-color: #e74c3c !important;
            background: rgba(231, 76, 60, 0.1) !important;
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.3) !important;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .playlist-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px 20px;
        }
        .playlist-video-item {
            background: #1a1d23;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            transition: all 0.2s;
        }
        .playlist-video-item:hover {
            border-color: #555;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .playlist-video-item.selected {
            border-color: #2ecc71;
            background: #1e2a24;
        }
        .playlist-video-checkbox {
            width: 20px;
            height: 20px;
            margin-top: 4px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .playlist-video-thumb {
            width: 100px;
            height: 75px;
            border-radius: 6px;
            object-fit: cover;
            flex-shrink: 0;
            background: #181a20;
        }
        .playlist-video-info {
            flex: 1;
            min-width: 0;
        }
        .playlist-video-title {
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 4px;
            word-break: break-word;
            line-height: 1.3;
        }
        .playlist-video-meta {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 0;
        }
        .playlist-video-controls {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            flex-shrink: 0;
            margin-left: auto;
        }
        .playlist-video-select {
            width: 100px;
        }
        .playlist-video-controls .custom-select {
            width: 100px;
            position: relative;
        }
        .playlist-video-controls .custom-select-header {
            padding: 5px 8px;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .playlist-video-controls .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            width: 100%;
            min-width: 100px;
            z-index: 10001;
            max-height: 150px;
        }
        .playlist-video-controls .custom-select-option {
            padding: 6px 8px;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .playlist-modal-footer {
            padding: 10px 20px;
            border-top: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .playlist-selected-count {
            color: #aaa;
            font-size: 14px;
        }
        .playlist-download-btn {
            background: #27ae60;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .playlist-download-btn:hover {
            background: #219150;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }
        .playlist-download-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* 新增佇列頁面樣式 */
        .queue-search-row {
            width: 90%;
            max-width: 600px;
            margin-top: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .queue-list {
            width: 90%; /* 調整列表寬度 */
            max-width: 800px; /* 最大寬度限制 */
            display: flex;
            flex-direction: column;
            align-items: center; /* 讓列表項居中 */
            padding-bottom: 110px; /* 下修預留高度，讓列表可視範圍更大 */
        }

        .queue-bottom {
            position: sticky; /* 置於主內容底部，不覆蓋左側標籤列 */
            bottom: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 0 12px; /* 縮小上下高度 */
            background: #181a20; /* 與頁面一致，避免透出 */
            z-index: 1200; /* 高於一般內容，低於模態視窗(>10000) */
            box-shadow: 0 -6px 24px rgba(0,0,0,0.35);
        }

        .queue-item {
            background: #2b2e37; /* 項目背景色 */
            border-radius: 12px;
            padding: 10px 15px; /* 縮小內邊距 */
            /* margin-bottom: 20px; */ /* 項目間距由分隔線控制 */
            width: 100%;
            display: flex;
            align-items: flex-start; /* 縮圖和文字頂部對齊 */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden; /* 防止內容溢出 */
            transition: all 0.2s ease;
        }
        
        .queue-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }

        .queue-item.completed {
            border: 2px solid #2ecc71;
            background: #1e2a24;
        }

        .queue-item.completed:hover {
            border-color: #27ae60;
            box-shadow: 0 6px 16px rgba(46, 204, 113, 0.3);
        }

        .queue-item-thumbnail {
            width: 100px; /* 縮圖寬度 - 縮小 */
            height: 70px; /* 縮圖高度 - 縮小 */
            object-fit: cover; /* 裁剪圖片以填充 */
            border-radius: 8px;
            margin-right: 12px; /* 縮小右邊距 */
            flex-shrink: 0; /* 防止縮圖被壓縮 */
            background-color: #181a20; /* 縮圖載入前的背景 */
            display: flex; /* 讓內容居中 */
            align-items: center;
            justify-content: center;
            color: #b0b0b0; /* 文字顏色 */
            font-size: 12px; /* 文字大小 */
            text-align: center;
            line-height: 1.2;
            padding: 5px; /* 內邊距 */
        }

        .queue-item-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .queue-item-info {
            flex-grow: 1; /* 資訊部分佔據剩餘空間 */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* 頂部對齊 */
        }

        .queue-item-title {
            font-size: 16px; /* 縮小字體 */
            font-weight: bold;
            color: #e5e7eb;
            margin-bottom: 3px; /* 縮小下邊距 */
            word-break: break-all; /* 長標題自動換行 */
            text-align: left;
        }

        .queue-item-meta,
        .queue-item-url {
            font-size: 13px; /* 縮小字體 */
            color: #b0b0b0;
            margin-bottom: 2px; /* 縮小下邊距 */
            word-break: break-all;
            text-align: left;
        }

        .queue-item-url a {
            color: #2ecc71;
            text-decoration: none;
        }
        .queue-item-url a:hover {
            text-decoration: underline;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #444;
            border-radius: 5px;
            height: 8px;
            margin-top: 6px; /* 縮小上邊距 */
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            width: 0%; /* 初始為0 */
            background: #2ecc71;
            border-radius: 5px;
            transition: width 0.3s var(--ease-smooth);
        }
        
        

        .progress-text {
            font-size: 12px; /* 縮小字體 */
            color: #888;
            margin-top: 3px; /* 縮小上邊距 */
            text-align: right;
        }

        .completed-badge {
            margin-top: 6px;
            color: #2ecc71;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .completed-badge::before {
            content: '✓';
            color: #2ecc71;
            font-size: 14px;
            font-weight: bold;
        }

        .queue-separator {
            width: 95%;
            max-width: 800px; /* 加長分隔線 */
            height: 1px;
            background-color: #3a3f4a;
            margin: 0 auto 8px; /* 縮小與輸入區距離 */
        }
        .queue-item-actions {
            display: flex;
            align-items: center;
            margin-left: auto; /* 將按鈕推到最右邊 */
        }
        .queue-item-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }
        .queue-item-action-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.1);
        }
        .queue-item-action-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .queue-item-action-btn:disabled img {
            filter: brightness(0.5);
        }
        .queue-item-action-btn img {
            width: 24px;
            height: 24px;
            filter: brightness(0.85);
            transition: filter 0.2s ease;
        }
        
        /* 設定頁面樣式 */
        .settings-page {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
            position: relative;
            overflow-x: hidden; /* 防止水平捲軸 */
        }
        
        .settings-container {
            background: #23262f;
            border-radius: 16px;
            padding: 40px;
            padding-bottom: 20px; /* 減少底部間距 */
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid #333;
            position: relative;
            overflow-x: hidden; /* 防止水平捲軸 */
        }
        
        .settings-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #1a1d23;
            border-radius: 12px;
        }
        
        .settings-section-title {
            font-size: 20px;
            color: #2ecc71;
            margin: 0 0 20px 0;
            font-weight: 600;
        }
        
        .settings-item {
            margin-bottom: 15px;
        }
        
        .settings-checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
            color: #e5e7eb;
            user-select: none;
        }
        
        .settings-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #2ecc71;
            cursor: pointer;
            margin-right: 8px;
        }
        
        .settings-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #1a1d23;
            color: #e5e7eb;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        
        .settings-input:focus {
            outline: none;
            border-color: #2ecc71;
        }
        
        .settings-input:read-only {
            cursor: pointer;
        }
        
        .settings-bottom {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: #23262f;
            border-top: 1px solid #3a3f4a;
            padding: 20px 40px;
            border-radius: 0 0 16px 16px;
        }
        
        .settings-separator {
            display: none; /* 隱藏分隔線，因為已經有邊框 */
        }
        
        .settings-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin: 0;
            padding: 0;
            background: transparent;
        }
        
        /* 設定頁面固定底部操作區 - 完全複製佇列頁面樣式 */
        .settings-fixed-bottom {
            position: sticky; /* 置於主內容底部，不覆蓋左側標籤列 */
            bottom: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 0 6px; /* 進一步縮小上下高度 */
            background: #181a20; /* 與頁面一致，避免透出 */
            z-index: 1200; /* 高於一般內容，低於模態視窗(>10000) */
            box-shadow: 0 -6px 24px rgba(0,0,0,0.35);
            margin-left: 0; /* 確保不與左側邊欄重疊 */
        }
        
        .settings-fixed-content {
            width: 100%;
            max-width: 800px;
            margin-top: 4px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end; /* 按鈕右對齊 */
            gap: 10px;
            padding-right: 20px; /* 與右邊緣保持距離 */
        }
        
        .settings-btn-secondary,
        .settings-btn-primary {
            padding: 10px 18px; /* 依文字自適應大小 */
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s var(--ease-smooth);
            white-space: nowrap; /* 保持單行 */
        }
        
        .settings-btn-secondary {
            background: #444;
            color: #e5e7eb;
        }
        
        .settings-btn-secondary:hover {
            background: #555;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .settings-btn-primary {
            background: #2ecc71;
            color: white;
        }
        
        .settings-btn-primary:hover {
            background: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }
        
        /* 淺色主題的設定頁面樣式 */
        body.light-theme .settings-container {
            background: #ffffff;
            border-color: #ddd;
            color: #333;
        }
        
        body.light-theme .settings-section {
            background: #f5f5f5;
        }
        
        body.light-theme .settings-section-title {
            color: #2ecc71;
        }
        
        body.light-theme .settings-checkbox-label {
            color: #333;
        }

        /* Toast 通知樣式 */
        #toast-container {
            position: fixed;
            bottom: 32px;
            right: 32px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 12000;
            pointer-events: none;
        }

        .toast-item {
            min-width: 280px;
            max-width: 360px;
            background: rgba(32, 36, 45, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(78, 205, 143, 0.35);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
            border-radius: 16px;
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            color: #f3f4f6;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            animation: toastSlideIn 0.4s var(--ease-smooth);
            pointer-events: auto;
            position: relative;
            overflow: hidden;
        }

        .toast-item.success {
            border-color: rgba(46, 204, 113, 0.55);
        }

        .toast-item .toast-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: 0.3px;
        }

        .toast-item .toast-message {
            font-size: 14px;
            color: #d1d5db;
            line-height: 1.5;
        }

        .toast-item .toast-close {
            position: absolute;
            top: 10px;
            right: 12px;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            line-height: 1;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .toast-item .toast-close:hover {
            color: #f3f4f6;
            transform: scale(1.05);
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            width: 100%;
            background: rgba(255,255,255,0.08);
        }

        .toast-progress > span {
            display: block;
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transform-origin: left;
            animation: toastProgress 4.5s linear forwards;
        }

        @keyframes toastSlideIn {
            0% {
                transform: translateY(24px) translateX(20px);
                opacity: 0;
            }
            100% {
                transform: translateY(0) translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastFadeOut {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateY(8px) scale(0.97);
            }
        }

        @keyframes toastProgress {
            from { transform: scaleX(1); }
            to { transform: scaleX(0); }
        }

        body.light-theme .toast-item {
            background: rgba(248, 250, 252, 0.95);
            color: #1f2933;
            border-color: rgba(46, 204, 113, 0.45);
        }

        body.light-theme .toast-item .toast-message {
            color: #374151;
        }

        /* 禁止選取所有文字和圖片，除了影片資訊 */
        * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* 允許選取影片資訊 */
        .video-modal-title,
        .video-modal-meta,
        .video-modal-uploader {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        
        /* 允許選取輸入框文字 */
        input[type="text"],
        input[type="password"],
        textarea {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        
        /* 禁止選取圖片 */
        img {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-user-drag: none; /* 防止拖拽圖片 */
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
        }

    </style>
</head>
<body>
    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="menu-btn" onclick="toggleSidebar()">
                <img src="assets/menu.png" alt="menu" style="width:32px;height:32px;">
            </div>
            <div class="nav-item selected" id="nav-home" onclick="showPage('home')">
                <img src="assets/home.png" alt="主頁">
                <span class="nav-text">主頁</span>
            </div>
            <div class="nav-item" id="nav-queue" onclick="showPage('queue')">
                <img src="assets/quene.png" alt="佇列">
                <span class="nav-text">佇列</span>
            </div>
            <!-- 將以下兩個按鈕固定在側邊欄底部 -->
            <div style="flex:1"></div>
            <div class="nav-item" id="nav-settings" onclick="showPage('settings')">
                <img src="assets/settings.png" alt="設定">
                <span class="nav-text">設定</span>
            </div>
            <div class="nav-item" id="nav-about" onclick="showPage('about')">
                <img src="assets/about.png" alt="關於">
                <span class="nav-text">關於</span>
            </div>
        </div>
        <div class="main">
            <img class="title-img" id="title-img" src="assets/icon_text.png" alt="">
            <div class="search-row" id="search-row">
                <input class="search-input" id="video-url" type="text" placeholder="請輸入影片網址...">
                <button class="download-btn" onclick="downloadVideo()">下載</button>
            </div>
            

            <!-- 佇列頁面改造 -->
            <div class="queue-page" id="queue-page"> <!-- 移除 hidden class，改由 JS 完全控制 -->
                <div class="queue-list" id="queue-list">
                    <!-- 影片任務將會動態新增到這裡 -->
                </div>
                <div class="queue-bottom">
                    <div class="queue-separator"></div>
                    <!-- 佇列頁面的輸入框（置底置中） -->
                    <div class="queue-search-row" id="queue-search-row">
                        <input class="search-input" id="queue-video-url" type="text" placeholder="請輸入影片網址...">
                        <button class="download-btn" onclick="downloadVideoFromQueue()">下載</button>
                    </div>
                </div>
            </div>

            <!-- 設定頁面 -->
            <div class="settings-page" id="settings-page" style="display: none;">
                <div class="settings-container">
                    <h2 style="margin: 0 0 30px 0; color: #e5e7eb; font-size: 28px;">設定</h2>
                    
                    <div class="settings-section">
                        <h3 class="settings-section-title">通知設定</h3>
                        <div class="settings-item">
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="enable-notifications" class="settings-checkbox">
                                <span style="margin-left: 8px;">啟用下載完成通知(實驗性)</span>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3 class="settings-section-title">下載設定</h3>
                        <div class="settings-item">
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="add-resolution-to-filename" class="settings-checkbox">
                                <span style="margin-left: 8px;">在檔名後方加上影片格式</span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <label class="settings-label" style="display: block; margin-bottom: 8px; color: #e5e7eb; font-size: 16px;">
                                同時下載上限（建議 3~5）：
                            </label>
                            <input type="number" id="max-concurrent-downloads" class="settings-input"
                                   min="1" max="10" step="1"
                                   style="width: 140px; padding: 10px 12px; border: 1px solid #444; border-radius: 8px; background: #1a1d23; color: #e5e7eb; font-size: 14px;">
                        </div>
                        <div class="settings-item">
                            <label class="settings-label" style="display: block; margin-bottom: 8px; color: #e5e7eb; font-size: 16px;">
                                下載路徑：
                            </label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="text" id="custom-download-path" class="settings-input" 
                                       placeholder="請選擇下載路徑" readonly
                                       style="flex: 1; padding: 10px 12px; border: 1px solid #444; border-radius: 8px; background: #1a1d23; color: #e5e7eb; font-size: 14px;">
                                <button type="button" id="browse-download-path" class="settings-btn-secondary" 
                                        style="padding: 10px 16px; white-space: nowrap;">
                                    瀏覽
                                </button>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- 設定頁面固定底部操作區 -->
                <div class="settings-fixed-bottom" id="settings-fixed-bottom" style="display: none;">
                    <div class="queue-separator"></div>
                    <div class="settings-fixed-content">
                        <button class="settings-btn-secondary" onclick="resetSettings()">重設為預設值</button>
                    </div>
                </div>
            </div>

            <!-- 關於頁面 -->
            <div class="settings-page" id="about-page" style="display: none;">
                <div class="settings-container" style="position: relative; display:flex; flex-direction:column; align-items:center; padding:40px;">
                    <img src="assets/icon_text.png" alt="logo" style="width:420px; max-width:80%; margin:0 0 16px 0; filter:drop-shadow(0 0 8px #222);">
                    <div style="width:100%; max-width:680px;">
                        <div class="settings-item" style="color:#e5e7eb; font-size:15px; margin-bottom:8px;">
                            版本：<span id="about-version">—</span>
                        </div>
                        <div class="settings-item" style="color:#e5e7eb; font-size:15px; margin-bottom:8px;">
                            發布日期：2025.01.20
                        </div>
                        <div class="settings-item" style="color:#e5e7eb; font-size:15px; margin-bottom:8px;">
                            作者：老魚oldfish
                        </div>
                        <div class="settings-item" style="margin:16px 0 0 0;">
                            <a id="about-github" href="#" style="color:#2ecc71; text-decoration:none;">前往 GitHub 專案</a>
                        </div>
                        <div id="about-footer" style="text-align:center; color:#888; font-size:12px; margin-top:24px;">
                            © 2025 老魚oldfish.
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <!-- 全局載入中遮罩 -->
    <div class="loading-bg" id="loading-bg" style="position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.45); z-index: 15000; display: none;">
        <div style="position:absolute; top:50%; left:50%; transform: translate(-50%,-50%); background:#23262f; color:#e5e7eb; padding:16px 22px; border-radius:12px; box-shadow:0 4px 24px #000a; font-size:16px;">
            載入中...
        </div>
    </div>
    <div class="modal-bg" id="modal-bg">
        <div class="modal">
            <img class="modal-icon" src="assets/icon.png" alt="icon">
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-msg" id="modal-msg"></div>
            <button class="modal-btn" onclick="closeModal()">確定</button>
        </div>
    </div>
    
    <!-- 確認對話框模態視窗 -->
    <div class="modal-bg" id="confirm-modal-bg">
        <div class="modal">
            <img class="modal-icon" src="assets/icon.png" alt="icon">
            <div class="modal-title" id="confirm-modal-title"></div>
            <div class="modal-msg" id="confirm-modal-msg"></div>
            <div class="modal-buttons">
                <button class="modal-btn-secondary" id="confirm-cancel-btn" onclick="closeConfirmModal()">取消</button>
                <button class="modal-btn-primary" id="confirm-ok-btn" onclick="confirmAction()">確定</button>
            </div>
        </div>
    </div>
    <div class="video-modal-bg" id="video-modal-bg">
        <div class="video-modal" id="video-modal">
            <div class="video-modal-loading" id="video-modal-loading">載入中...</div>
            <div id="video-modal-content" style="display:none;">
                <div class="video-modal-header">
                    <img class="video-modal-thumb" id="video-modal-thumb" src="assets/icon.png" alt="thumb">
                    <div class="video-modal-titlebox">
                        <div class="video-modal-title" id="video-modal-title"></div>
                        <div class="video-modal-meta" id="video-modal-meta"></div>
                    </div>
                </div>
                <div class="video-modal-options">
                    <div class="video-modal-options-wrapper">
                        <div class="video-modal-option-item">
                            <div class="video-modal-label" id="video-modal-quality-label">畫質</div>
                            <div class="custom-select" id="quality-select">
                                <div class="custom-select-header" onclick="toggleSelect('quality-select')">
                                    <span class="custom-select-text">請選擇畫質</span>
                                    <div class="custom-select-arrow"></div>
                                </div>
                                <div class="custom-select-options" id="quality-options"></div>
                            </div>
                        </div>
                        <div class="video-modal-option-item">
                            <div class="video-modal-label">影片格式</div>
                            <div class="custom-select" id="format-select">
                                <div class="custom-select-header" onclick="toggleSelect('format-select')">
                                    <span class="custom-select-text">請選擇格式</span>
                                    <div class="custom-select-arrow"></div>
                                </div>
                                <div class="custom-select-options" id="format-options"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="video-modal-actions">
                    <button class="video-modal-btn cancel" onclick="closeVideoModal()">取消</button>
                    <button class="video-modal-btn" onclick="confirmDownload()">下載</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 播放清單選擇模態視窗 -->
    <div class="playlist-modal-bg" id="playlist-modal-bg">
        <div class="playlist-modal">
            <div class="playlist-modal-header">
                <div>
                    <div class="playlist-modal-title" id="playlist-modal-title">播放清單</div>
                    <div class="playlist-modal-subtitle" id="playlist-modal-subtitle">共 0 部影片</div>
                </div>
                <button class="playlist-modal-close" onclick="closePlaylistModal()">×</button>
            </div>
            <div class="playlist-modal-toolbar">
                <label class="playlist-toolbar-check">
                    <input type="checkbox" id="playlist-select-all" onchange="onPlaylistSelectAllChanged(this.checked)">
                    全選
                </label>
                <label class="playlist-toolbar-check">
                    <input type="checkbox" id="playlist-apply-highest-quality" onchange="onPlaylistApplyHighestQualityChanged(this.checked)">
                    套用最高畫質/位元率
                </label>
                <div class="playlist-toolbar-select">
                    <div class="playlist-toolbar-select-label">影片格式(一次套用至所有)</div>
                    <div class="custom-select" id="playlist-global-format-select">
                        <div class="custom-select-header" onclick="togglePlaylistGlobalFormatSelect()">
                            <span class="custom-select-text">-請選擇影片格式-</span>
                            <div class="custom-select-arrow"></div>
                        </div>
                        <div class="custom-select-options" id="playlist-global-format-options">
                            <div class="custom-select-option" onclick="selectPlaylistGlobalFormatOption('')">-請選擇影片格式-</div>
                            <div class="custom-select-option" onclick="selectPlaylistGlobalFormatOption('mp4')">影片(mp4)</div>
                            <div class="custom-select-option" onclick="selectPlaylistGlobalFormatOption('mp3')">音訊(mp3)</div>
                            <div class="custom-select-option" onclick="selectPlaylistGlobalFormatOption('individual')">個別選擇格式</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="playlist-modal-content" id="playlist-modal-content">
                <!-- 播放清單影片列表將在這裡動態生成 -->
            </div>
            <div class="playlist-modal-footer">
                <div class="playlist-selected-count" id="playlist-selected-count">已選擇 0 部影片</div>
                <button class="playlist-download-btn" id="playlist-download-btn" onclick="startPlaylistDownload()" disabled>開始下載</button>
            </div>
        </div>
    </div>
    <script>
        // 重定向 console 輸出到 Python 端
        (function() {
            // 保存原始的 console 方法
            const originalConsole = {
                log: console.log.bind(console),
                error: console.error.bind(console),
                warn: console.warn.bind(console),
                info: console.info.bind(console),
                debug: console.debug.bind(console)
            };
            
            // 創建發送日誌到 Python 的函數
            function sendLogToPython(level, args) {
                try {
                    // 將參數轉換為字符串
                    const message = Array.from(args).map(arg => {
                        if (typeof arg === 'object') {
                            try {
                                return JSON.stringify(arg);
                            } catch (e) {
                                return String(arg);
                            }
                        }
                        return String(arg);
                    }).join(' ');
                    
                    // 嘗試發送到 Python 端
                    if (window.api && typeof window.api.log_from_js === 'function') {
                        window.api.log_from_js(level, message).catch(err => {
                            // 如果發送失敗，至少保留原生輸出
                            originalConsole.error('[日誌發送失敗]', err);
                        });
                    }
                } catch (e) {
                    // 如果出錯，至少保留原生輸出
                    originalConsole.error('[日誌重定向錯誤]', e);
                }
            }
            
            // 重寫 console 方法
            console.log = function(...args) {
                originalConsole.log(...args);
                sendLogToPython('log', args);
            };
            
            console.error = function(...args) {
                originalConsole.error(...args);
                sendLogToPython('error', args);
            };
            
            console.warn = function(...args) {
                originalConsole.warn(...args);
                sendLogToPython('warn', args);
            };
            
            console.info = function(...args) {
                originalConsole.info(...args);
                sendLogToPython('info', args);
            };
            
            console.debug = function(...args) {
                originalConsole.debug(...args);
                sendLogToPython('debug', args);
            };
            
            originalConsole.log('[前端] Console 輸出已重定向到 Python 端');
        })();
        
        // 添加全局錯誤處理和調試信息
        window.addEventListener('error', function(e) {
            console.error('[全局錯誤]', e.message, 'at', e.filename, ':', e.lineno, ':', e.colno);
            console.error('[錯誤堆棧]', e.error ? e.error.stack : '無堆棧信息');
        });
        
        // 檢查關鍵函數是否已定義
        function checkCriticalFunctions() {
            const functions = ['showPage', 'addDownloadTask', 'renderQueue', 'showModal', 'showConfirmModal', 'closeConfirmModal'];
            const missing = [];
            functions.forEach(func => {
                if (typeof window[func] !== 'function') {
                    missing.push(func);
                    console.error('[函數檢查] 函數未定義:', func);
                } else {
                    console.log('[函數檢查] 函數已定義:', func);
                }
            });
            if (missing.length > 0) {
                console.error('[函數檢查] 缺少以下函數:', missing.join(', '));
            }
        }
        
        // 在 DOM 加載完成後檢查
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkCriticalFunctions);
        } else {
            checkCriticalFunctions();
        }
        
        // 儲存上次獲取的影片資訊以還原畫質選項
        let lastVideoInfo = null;
        // 儲存目前正在處理的影片網址（從主頁或佇列進入）
        let currentUrl = '';

        // MP3, AAC, FLAC, WAV 的音訊品質選項
        const AUDIO_QUALITIES = [
            {label: "320kbps", value: "320"},
            {label: "256kbps", value: "256"},
            {label: "192kbps", value: "192"},
            {label: "128kbps", value: "128"}
        ];

        // 儲存所有下載任務的陣列
        let downloadQueue = [];
        let nextTaskId = 0; // 用於給每個任務一個獨特的ID
        window.__ofNotificationsEnabled = true;

        /**
         * 將影片畫質從高到低排序。
         * 處理 "4K", "1080p", "720p", "360p", "2K", "4K" 等格式。
         * @param {Array<Object>} qualities - 畫質物件陣列 {label: string, ratio: string}。
         * @returns {Array<Object>} 已排序的畫質。
         */
        function sortQualities(qualities) {
            return (qualities || []).slice().sort(function(a, b) {
                function getNum(s) {
                    if (typeof s.label === "string") {
                        if (s.label.endsWith("K")) {
                            let num = parseInt(s.label);
                            return !isNaN(num) ? num * 1000 : 0;
                        }
                        if (s.label.endsWith("p")) {
                            let num = parseInt(s.label);
                            return !isNaN(num) ? num : 0;
                        }
                    }
                    let num = parseInt(s.label); // 用於 "320kbps" 等情況
                    return !isNaN(num) ? num : 0;
                }
                return getNum(b) - getNum(a); // 降序排序
            });
        }

        /**
         * 排序格式，優先考慮 "mp4" 和 "mp3"。
         * @param {Array<Object>} formats - 格式物件陣列 {value: string, label: string, desc: string}。
         * @returns {Array<Object>} 已排序的格式。
         */
        function sortFormats(formats) {
            const priority = {"影片+音訊": 3, "影片": 2, "音訊": 1}; // 優先級定義
            return (formats || []).slice().sort(function(a, b) {
                let pa = priority[a.desc] || 0;
                let pb = priority[b.desc] || 0;
                if (pa !== pb) return pb - pa; // 按描述優先級降序
                return a.value.localeCompare(b.value); // 描述相同時按值字母順序
            });
        }

        /**
         * 確認網址是否為有效的 YouTube 網址。
         * @param {string} url - 要檢查的網址。
         * @returns {boolean} 是否為有效的 YouTube 網址。
         */
        function isYoutubeUrl(url) {
            return /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\//.test(url.trim());
        }

        /**
         * 切換側邊欄的折疊狀態。
         */
        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }
        

        /**
         * 顯示指定頁面並更新導航項目選擇。
         * @param {string} pageName - 要顯示的頁面名稱 ('home', 'queue', 或 'settings')。
         */
        function showPage(pageName) {
            document.getElementById('nav-home').classList.remove('selected');
            document.getElementById('nav-queue').classList.remove('selected');
            document.getElementById('nav-settings').classList.remove('selected');
            var navAbout = document.getElementById('nav-about');
            if (navAbout) navAbout.classList.remove('selected');

            // Get all main content elements
            const titleImg = document.getElementById('title-img');
            const searchRow = document.getElementById('search-row');
            const queuePage = document.getElementById('queue-page');
            const settingsPage = document.getElementById('settings-page');
            const aboutPage = document.getElementById('about-page');

            if (pageName === 'home') {
                document.getElementById('nav-home').classList.add('selected');
                
                // 顯示主頁元素
                if (titleImg) titleImg.style.display = 'block';
                if (searchRow) searchRow.style.display = 'flex';
                
                // 隱藏其他頁面
                if (queuePage) queuePage.style.display = 'none';
                if (settingsPage) settingsPage.style.display = 'none';
                if (aboutPage) aboutPage.style.display = 'none';
                
                // 隱藏設定頁面固定底部操作區
                const settingsFixedBottom = document.getElementById('settings-fixed-bottom');
                if (settingsFixedBottom) settingsFixedBottom.style.display = 'none';
                
            } else if (pageName === 'queue') {
                document.getElementById('nav-queue').classList.add('selected');
                
                // 隱藏主頁元素
                if (titleImg) titleImg.style.display = 'none';
                if (searchRow) searchRow.style.display = 'none';
                
                // 顯示佇列頁面
                if (queuePage) queuePage.style.display = 'flex';
                if (settingsPage) settingsPage.style.display = 'none';
                if (aboutPage) aboutPage.style.display = 'none';
                
                // 隱藏設定頁面固定底部操作區
                const settingsFixedBottom = document.getElementById('settings-fixed-bottom');
                if (settingsFixedBottom) settingsFixedBottom.style.display = 'none';
                
                renderQueue();
                
            } else if (pageName === 'settings') {
                document.getElementById('nav-settings').classList.add('selected');
                
                // 隱藏主頁元素
                if (titleImg) titleImg.style.display = 'none';
                if (searchRow) searchRow.style.display = 'none';
                
                // 隱藏佇列頁面，顯示設定頁面
                if (queuePage) queuePage.style.display = 'none';
                if (settingsPage) settingsPage.style.display = 'block';
                if (aboutPage) aboutPage.style.display = 'none';
                
                // 顯示設定頁面固定底部操作區
                const settingsFixedBottom = document.getElementById('settings-fixed-bottom');
                if (settingsFixedBottom) settingsFixedBottom.style.display = 'block';
                
                // 載入設定
                loadSettings();
            } else if (pageName === 'about') {
                var navA = document.getElementById('nav-about');
                if (navA) navA.classList.add('selected');
                // 隱藏主頁元素
                if (titleImg) titleImg.style.display = 'none';
                if (searchRow) searchRow.style.display = 'none';
                // 隱藏其他頁面
                if (queuePage) queuePage.style.display = 'none';
                if (settingsPage) settingsPage.style.display = 'none';
                if (aboutPage) aboutPage.style.display = 'block';
                
                // 隱藏設定頁面固定底部操作區
                const settingsFixedBottom = document.getElementById('settings-fixed-bottom');
                if (settingsFixedBottom) settingsFixedBottom.style.display = 'none';
                // 注入版本號與 GitHub 連結
                try { document.getElementById('about-version').textContent = (window.__APP_VERSION || '未知'); } catch(e) {}
                try {
                    var link = document.getElementById('about-github');
                    if (link) {
                        link.addEventListener('click', function(ev){
                            ev.preventDefault();
                            // 使用系統預設瀏覽器開啟
                            try { 
                                window.api.open_external_link('https://github.com/oldfish101240/oldfish-Video-Downloader');
                            } catch(e) {
                                console.error('無法開啟外部連結:', e);
                                // 備用方案
                                try { window.open('https://github.com/oldfish101240/oldfish-Video-Downloader', '_blank'); } catch(_) {}
                            }
                        });
                    }
                } catch(e) {}
            }
        }

        /**
         * 顯示一般訊息模態視窗。
         * @param {string} title - 訊息標題。
         * @param {string} message - 訊息內容。
         */
        function showModal(title, msg) {
            const modal = document.getElementById('modal-bg');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerHTML = msg;
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10); // 觸發動畫
        }

        /**
         * 隱藏一般訊息模態視窗。
         */
        function closeModal() {
            const modal = document.getElementById('modal-bg');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 200); // 等待動畫結束
        }
        
        /**
         * 顯示確認對話框
         */
        function showConfirmModal(title, message, onConfirm) {
            const modal = document.getElementById('confirm-modal-bg');
            document.getElementById('confirm-modal-title').innerText = title;
            document.getElementById('confirm-modal-msg').innerHTML = message;
            
            // 存儲確認回調函數
            window._confirmCallback = onConfirm;
            
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }
        
        /**
         * 關閉確認對話框
         */
        function closeConfirmModal() {
            const modal = document.getElementById('confirm-modal-bg');
            modal.classList.remove('show');
            
            // 如果取消的是文件已存在的確認，需要通知後端取消下載並從佇列中移除任務
            // 立即執行，不等待動畫完成
            if (window._pendingTaskId) {
                const taskId = window._pendingTaskId;
                delete window._pendingTaskId;
                
                // 從前端佇列中移除任務
                const taskIndex = downloadQueue.findIndex(task => task.id === taskId);
                if (taskIndex !== -1) {
                    downloadQueue.splice(taskIndex, 1);
                    renderQueue(); // 重新渲染佇列
                    console.log(`已從佇列中移除任務 ${taskId}`);
                } else {
                    console.warn(`找不到任務 ${taskId}，可能已經被移除`);
                }
                
                // 通知後端取消下載
                const backend = __getBackendApi();
                if (backend && backend.confirm_redownload) {
                    backend.confirm_redownload(taskId, false)
                        .then(result => {
                            console.log("取消下載結果:", result);
                        })
                        .catch(error => {
                            console.error("取消下載時出錯:", error);
                        });
                }
            }
            
            setTimeout(() => {
                modal.style.display = 'none';
                window._confirmCallback = null;
            }, 200);
        }
        
        /**
         * 確認操作
         */
        function confirmAction() {
            if (window._confirmCallback) {
                window._confirmCallback();
            }
            closeConfirmModal();
        }

        /**
         * 隱藏影片詳細資訊模態視窗。
         */
        function closeVideoModal() {
            const videoModalBg = document.getElementById('video-modal-bg');
            videoModalBg.classList.remove('show');
            setTimeout(() => {
                videoModalBg.style.display = 'none';
                hideLoading();
            }, 200);
        }

        /**
         * 處理佇列輸入框的Enter鍵按下。
         */
        function handleQueueInputKeyPress(event) {
            if (event.key === 'Enter') {
                downloadVideoFromQueue();
            }
        }
        
        /**
         * 從佇列頁面下載影片。
         */
        function downloadVideoFromQueue() {
            const urlInput = document.getElementById('queue-video-url');
            const url = urlInput.value.trim();
            
            if (!url) {
                showModal('錯誤', '請輸入影片網址');
                return;
            }
            
            // 與主頁一致：開啟影片資訊模態，讓使用者選擇格式再下載
            try { currentUrl = (url || '').trim(); } catch(e) { currentUrl = ''; }
            showVideoModal(url);
            
            // 清空輸入框
            urlInput.value = '';
        }

        /**
         * 處理主頁面上的下載按鈕點擊。
         * 獲取影片資訊並顯示影片詳細資訊模態視窗。
         */
        async function downloadVideo() {
            var url = document.getElementById('video-url').value;
            if (!url.trim()) {
                showModal("提醒", "請輸入影片網址！");
                return;
            }
            if (!isYoutubeUrl(url)) {
                showModal("網址格式錯誤", "</div><div style='text-align:left;'><br>正確格式範例：<br>https://www.youtube.com/watch?v=xxxx<br>https://youtu.be/xxxx</div>");
                return;
            }
            // 立即顯示載入中，避免前一層阻塞繪製
            requestAnimationFrame(() => showLoading());
            // 設置 currentUrl，避免之後確認下載時讀到空字串
            try { currentUrl = (url || '').trim(); } catch(e) { currentUrl = ''; }
            showVideoModal(url);
        }

        /**
         * 載入設定
         */
        function loadSettings() {
            if (window.pywebview && window.pywebview.api) {
                window.pywebview.api.load_settings()
                    .then(settings => {
                        console.log('設定已載入:', settings);
                        window.__ofNotificationsEnabled = settings.enableNotifications !== false;
                        // 更新 UI
                        const notificationCheckbox = document.getElementById('enable-notifications');
                        if (notificationCheckbox) {
                            notificationCheckbox.checked = settings.enableNotifications !== false;
                        }
                        
                        const resolutionCheckbox = document.getElementById('add-resolution-to-filename');
                        if (resolutionCheckbox) {
                            resolutionCheckbox.checked = settings.addResolutionToFilename === true;
                        }

                        const maxConcInput = document.getElementById('max-concurrent-downloads');
                        if (maxConcInput) {
                            let v = Number(settings.maxConcurrentDownloads || 3);
                            if (!isFinite(v)) v = 3;
                            v = Math.max(1, Math.min(10, Math.round(v)));
                            maxConcInput.value = String(v);
                        }
                        
                        const downloadPathInput = document.getElementById('custom-download-path');
                        if (downloadPathInput) {
                            downloadPathInput.value = settings.customDownloadPath || '';
                        }
                        
                        // 為設定項目添加自動儲存事件監聽器
                        setupAutoSaveListeners();
                    })
                    .catch(error => {
                        console.error('載入設定失敗:', error);
                    });
            }
        }
        
        /**
         * 設置自動儲存事件監聽器
         */
        function setupAutoSaveListeners() {
            // 防止重複綁定事件監聽器
            if (window._listenersSetup) {
                return;
            }
            window._listenersSetup = true;
            
            // 為通知設定添加變更監聽器
            const notificationCheckbox = document.getElementById('enable-notifications');
            if (notificationCheckbox && !notificationCheckbox.hasAttribute('data-listener-added')) {
                notificationCheckbox.addEventListener('change', function() {
                    console.log('通知設定已變更，自動儲存中...');
                    window.__ofNotificationsEnabled = !!this.checked;
                    saveSettings(true); // 靜默儲存
                });
                notificationCheckbox.setAttribute('data-listener-added', 'true');
            }
            
            // 為解析度設定添加變更監聽器
            const resolutionCheckbox = document.getElementById('add-resolution-to-filename');
            if (resolutionCheckbox && !resolutionCheckbox.hasAttribute('data-listener-added')) {
                resolutionCheckbox.addEventListener('change', function() {
                    console.log('解析度設定已變更，自動儲存中...');
                    saveSettings(true); // 靜默儲存
                });
                resolutionCheckbox.setAttribute('data-listener-added', 'true');
            }
            
            // 為下載路徑設定添加變更監聽器
            const downloadPathInput = document.getElementById('custom-download-path');
            if (downloadPathInput && !downloadPathInput.hasAttribute('data-listener-added')) {
                downloadPathInput.addEventListener('change', function() {
                    console.log('下載路徑已變更，自動儲存中...');
                    saveSettings(true); // 靜默儲存
                });
                downloadPathInput.setAttribute('data-listener-added', 'true');
            }

            // 同時下載上限變更時自動儲存
            const maxConcInput = document.getElementById('max-concurrent-downloads');
            if (maxConcInput && !maxConcInput.hasAttribute('data-listener-added')) {
                maxConcInput.addEventListener('change', function() {
                    let v = Number(this.value || 3);
                    if (!isFinite(v)) v = 3;
                    v = Math.max(1, Math.min(10, Math.round(v)));
                    this.value = String(v);
                    saveSettings(true);
                });
                maxConcInput.setAttribute('data-listener-added', 'true');
            }
            
            // 為瀏覽按鈕添加點擊事件
            const browseButton = document.getElementById('browse-download-path');
            if (browseButton && !browseButton.hasAttribute('data-listener-added')) {
                browseButton.addEventListener('click', function() {
                    if (window.pywebview && window.pywebview.api) {
                        window.pywebview.api.choose_folder()
                            .then(selectedPath => {
                                if (selectedPath) {
                                    downloadPathInput.value = selectedPath;
                                    console.log('下載路徑已變更，自動儲存中...');
                                    saveSettings(true); // 靜默儲存
                                }
                            })
                            .catch(error => {
                                console.error('選擇資料夾失敗:', error);
                            });
                    }
                });
                browseButton.setAttribute('data-listener-added', 'true');
            }
        }
        
        /**
         * 儲存設定（靜默模式，不顯示成功訊息）
         */
        function saveSettings(silent = false) {
            const notificationCheckbox = document.getElementById('enable-notifications');
            const resolutionCheckbox = document.getElementById('add-resolution-to-filename');
            const downloadPathInput = document.getElementById('custom-download-path');
            const maxConcInput = document.getElementById('max-concurrent-downloads');
            const settings = {
                enableNotifications: notificationCheckbox ? notificationCheckbox.checked : true,
                addResolutionToFilename: resolutionCheckbox ? resolutionCheckbox.checked : false,
                customDownloadPath: downloadPathInput ? downloadPathInput.value : '',
                maxConcurrentDownloads: maxConcInput ? Number(maxConcInput.value || 3) : 3
            };
            window.__ofNotificationsEnabled = settings.enableNotifications !== false;
            
            if (window.pywebview && window.pywebview.api) {
                window.pywebview.api.save_settings(settings)
                    .then(() => {
                        console.log('設定已儲存');
                        if (!silent) {
                            showModal('成功', '設定已儲存');
                        }
                    })
                    .catch(error => {
                        console.error('儲存設定失敗:', error);
                        if (!silent) {
                            showModal('錯誤', '儲存設定失敗');
                        }
                    });
            }
        }
        
        /**
         * 重設為預設值
         */
        function resetSettings() {
            showConfirmModal(
                '重設設定', 
                '確定要重設所有設定為預設值嗎？', 
                function() {
                    if (window.pywebview && window.pywebview.api) {
                        window.pywebview.api.reset_to_defaults()
                            .then(settings => {
                                console.log('設定已重設:', settings);
                                window.__ofNotificationsEnabled = settings.enableNotifications !== false;
                                // 更新 UI
                                const notificationCheckbox = document.getElementById('enable-notifications');
                                if (notificationCheckbox) {
                                    notificationCheckbox.checked = settings.enableNotifications !== false;
                                }
                                
                                const resolutionCheckbox = document.getElementById('add-resolution-to-filename');
                                if (resolutionCheckbox) {
                                    resolutionCheckbox.checked = settings.addResolutionToFilename === true;
                                }
                                
                                const downloadPathInput = document.getElementById('custom-download-path');
                                if (downloadPathInput) {
                                    downloadPathInput.value = settings.customDownloadPath || '';
                                }
                                // 自動儲存重設後的設定
                                saveSettings(true); // 靜默儲存
                                showModal('成功', '設定已重設為預設值');
                            })
                            .catch(error => {
                                console.error('重設設定失敗:', error);
                                showModal('錯誤', '重設設定失敗');
                            });
                    }
                }
            );
        }

        function showLoading() {
            var lb = document.getElementById('loading-bg');
            if (lb) { lb.style.display = 'flex'; }
        }
        function hideLoading() {
            var lb = document.getElementById('loading-bg');
            if (lb) { lb.style.display = 'none'; }
        }

        window.__ofShowToast = function(title, message, variant = 'success') {
            try {
                if (!window.__ofNotificationsEnabled) {
                    return;
                }
                const container = document.getElementById('toast-container');
                if (!container) {
                    console.warn('toast container missing');
                    return;
                }

                const toast = document.createElement('div');
                toast.className = `toast-item ${variant || 'success'}`.trim();

                const titleEl = document.createElement('div');
                titleEl.className = 'toast-title';
                const iconWrap = document.createElement('span');
                iconWrap.style.cssText = 'display:inline-flex;width:26px;height:26px;border-radius:8px;background:rgba(46,204,113,0.18);align-items:center;justify-content:center;font-size:14px;color:#2ecc71;font-weight:700;';
                iconWrap.textContent = '✓';
                const titleText = document.createElement('span');
                titleText.textContent = title || '通知';
                titleEl.appendChild(iconWrap);
                titleEl.appendChild(titleText);

                const msgEl = document.createElement('div');
                msgEl.className = 'toast-message';
                msgEl.textContent = message || '';

                const closeBtn = document.createElement('button');
                closeBtn.className = 'toast-close';
                closeBtn.setAttribute('aria-label', '關閉通知');
                closeBtn.innerHTML = '&times;';

                const progressBar = document.createElement('div');
                progressBar.className = 'toast-progress';
                const progress = document.createElement('span');
                progressBar.appendChild(progress);

                toast.appendChild(titleEl);
                toast.appendChild(msgEl);
                toast.appendChild(closeBtn);
                toast.appendChild(progressBar);

                container.appendChild(toast);

                const hideToast = () => {
                    toast.style.animation = 'toastFadeOut 0.35s forwards';
                    setTimeout(() => {
                        toast.remove();
                    }, 320);
                };

                const autoTimer = setTimeout(hideToast, 4500);

                closeBtn.addEventListener('click', () => {
                    clearTimeout(autoTimer);
                    hideToast();
                });

            } catch (err) {
                console.error('顯示 Toast 失敗', err);
            }
        };

        /**
         * 顯示影片詳細資訊模態視窗。
         * @param {string} url - 影片網址。
         */
        function showVideoModal(url) {
            // 記錄目前處理的網址供確認下載使用
            try { currentUrl = (url || '').trim(); } catch(e) { currentUrl = ''; }
            
            // 檢測是否為播放清單URL
            if (url && (url.includes('list=') || url.includes('/playlist'))) {
                console.log('[前端] 檢測到播放清單URL，直接顯示播放清單模態視窗');
                showPlaylistModal(url);
                return;
            }
            
            const videoModalBg = document.getElementById('video-modal-bg');
            videoModalBg.style.display = 'flex';
            setTimeout(() => videoModalBg.classList.add('show'), 10);
            document.getElementById('video-modal-loading').style.display = '';
            document.getElementById('video-modal-content').style.display = 'none';
            // 使用 requestAnimationFrame 確保樣式更新後再顯示，避免同步阻塞不重繪
            requestAnimationFrame(() => showLoading());
            // 背景取得影片資訊，前端以回呼接收，避免阻塞
            setTimeout(function(){
                window.__videoInfoCallback = function(info) {
                    console.log('[前端] showVideoModal 收到資訊回調', info);
                    // 檢查是否為播放清單資訊
                    if (info && info.is_playlist) {
                        console.log('[前端] 檢測到播放清單資訊，切換到播放清單模態視窗');
                        closeVideoModal();
                        showPlaylistModal(url, info);
                        return;
                    }
                    try { lastVideoInfo = info; } catch(e) {}

                    // 畫質選項（由高到低排序）
                    var qualityOptions = document.getElementById('quality-options');
                    qualityOptions.innerHTML = '';
                    var qualities = (info.qualities || []).slice();
                    // 過濾掉低於360p的畫質選項
                    qualities = qualities.filter(function(q) {
                        function getValue(q) {
                            if (q.label.endsWith('K')) return parseInt(q.label) * 1000;
                            var m = q.label.match(/(\d+)p/);
                            return m ? parseInt(m[1]) : 0;
                        }
                        return getValue(q) >= 360;
                    });
                    qualities.sort(function(a, b) {
                        // 解析 label 內的數字（如 4K, 1080p, 720p, 480p, 360p）
                        function getValue(q) {
                            if (q.label.endsWith('K')) return parseInt(q.label) * 1000;
                            var m = q.label.match(/(\d+)p/);
                            return m ? parseInt(m[1]) : 0;
                        }
                        return getValue(b) - getValue(a);
                    });
                    qualities.forEach(function(q) {
                        var optionDiv = document.createElement('div');
                        optionDiv.className = 'custom-select-option';
                        optionDiv.textContent = q.label + (q.ratio ? ' ' + q.ratio : ''); // 顯示畫面比例
                        optionDiv.onclick = () => selectOption('quality-select', q.label, q.label + (q.ratio ? ' ' + q.ratio : ''));
                        if (q.label === '1080p') {
                            optionDiv.classList.add('selected');
                            const qualitySelectText = document.querySelector('#quality-select .custom-select-text');
                            if (qualitySelectText) {
                                qualitySelectText.textContent = q.label + (q.ratio ? ' ' + q.ratio : '');
                            }
                            currentQuality = q.label;
                        }
                        qualityOptions.appendChild(optionDiv);
                    });

                    // 格式選項（mp4和mp3優先）
                    var formatOptions = document.getElementById('format-options');
                    formatOptions.innerHTML = '';
                    var formats = (info.formats || []).slice();
                    formats.sort(function(a, b) {
                        var priority = {"影片+音訊": 3, "影片": 2, "音訊": 1};
                        var pa = priority[a.desc] || 0;
                        var pb = priority[b.desc] || 0;
                        if (pa !== pb) return pb - pa;
                        return a.value.localeCompare(b.value);
                    });
                    formats.forEach(function(f) {
                        var optionDiv = document.createElement('div');
                        optionDiv.className = 'custom-select-option';
                        optionDiv.textContent = f.label + (f.desc ? ' (' + f.desc + ')' : '');
                        optionDiv.onclick = () => selectOption('format-select', f.value, f.label + (f.desc ? ' (' + f.desc + ')' : ''));
                        if (f.value === 'mp4') {
                            optionDiv.classList.add('selected');
                            const formatSelectText = document.querySelector('#format-select .custom-select-text');
                            if (formatSelectText) {
                                formatSelectText.textContent = f.label + (f.desc ? ' (' + f.desc + ')' : '');
                            }
                            currentFormat = f.value;
                        }
                        formatOptions.appendChild(optionDiv);
                    });

                    // 設定預設值
                    if (!currentQuality && qualities.length > 0) {
                        currentQuality = qualities[0].label;
                        const qualitySelectText = document.querySelector('#quality-select .custom-select-text');
                        if (qualitySelectText) {
                            qualitySelectText.textContent = qualities[0].label + (qualities[0].ratio ? ' ' + qualities[0].ratio : '');
                        }
                    }
                    if (!currentFormat && formats.length > 0) {
                        currentFormat = formats[0].value;
                        const formatSelectText = document.querySelector('#format-select .custom-select-text');
                        if (formatSelectText) {
                            formatSelectText.textContent = formats[0].label + (formats[0].desc ? ' (' + formats[0].desc + ')' : '');
                        }
                    }

                    // 縮圖處理：如果 info.thumb 不存在或載入失敗，顯示文字
                    const thumbElement = document.getElementById('video-modal-thumb');
                    if (info.thumb) {
                        thumbElement.src = info.thumb;
                        thumbElement.style.display = '';
                        thumbElement.alt = "影片縮圖";
                        const existingNoThumbText = thumbElement.parentNode.querySelector('.video-modal-thumb-text');
                        if (existingNoThumbText) { existingNoThumbText.remove(); }
                    } else {
                        thumbElement.src = '';
                        thumbElement.style.display = 'none';
                        let noThumbText = thumbElement.parentNode.querySelector('.video-modal-thumb-text');
                        if (!noThumbText) {
                            noThumbText = document.createElement('div');
                            noThumbText.classList.add('video-modal-thumb-text');
                            noThumbText.innerText = "找不到縮圖";
                            noThumbText.style.width = '100%';
                            noThumbText.style.height = '100%';
                            noThumbText.style.display = 'flex';
                            noThumbText.style.alignItems = 'center';
                            noThumbText.style.justifyContent = 'center';
                            noThumbText.style.backgroundColor = '#181a20';
                            noThumbText.style.borderRadius = '8px';
                            noThumbText.style.color = '#b0b0b0';
                            noThumbText.style.fontSize = '12px';
                            noThumbText.style.textAlign = 'center';
                            noThumbText.style.lineHeight = '1.2';
                            noThumbText.style.padding = '5px';
                            thumbElement.parentNode.insertBefore(noThumbText, thumbElement.nextSibling);
                        }
                    }

                    document.getElementById('video-modal-title').innerText = info.title || '';
                    const uploader = info.uploader || '未知上傳者';
                    const duration = info.duration || '未知時長';
                    document.getElementById('video-modal-meta').innerText = `${uploader} · ${duration}`;
                    document.getElementById('video-modal-loading').style.display = 'none';
                    document.getElementById('video-modal-content').style.display = '';
                    hideLoading();
                };
                window.__videoInfoErrorCallback = function(error) {
                    console.error('獲取影片資訊時出錯:', error);
                    showModal('錯誤', '找不到影片，請確認網址是否輸入正確');
                    closeVideoModal();
                    hideLoading();
                };
                window.pywebview.api.start_get_video_info(url);
            }, 0);
        }

        // 自定義下拉選單相關變數
        let currentQuality = '';
        let currentFormat = '';
        let isQualitySelectOpen = false;
        let isFormatSelectOpen = false;

        /**
         * 切換下拉選單的開關狀態
         */
        function toggleSelect(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const options = select.querySelector('.custom-select-options');
            const header = select.querySelector('.custom-select-header');
            
            if (!options || !header) return;
            
            // 關閉其他下拉選單
            if (selectId === 'quality-select') {
                closeSelect('format-select');
                closeSelect('theme-select');
                isQualitySelectOpen = !isQualitySelectOpen;
                if (isQualitySelectOpen) {
                    options.classList.add('show');
                    header.classList.add('active');
                } else {
                    options.classList.remove('show');
                    header.classList.remove('active');
                }
            } else if (selectId === 'format-select') {
                closeSelect('quality-select');
                closeSelect('theme-select');
                isFormatSelectOpen = !isFormatSelectOpen;
                if (isFormatSelectOpen) {
                    options.classList.add('show');
                    header.classList.add('active');
                } else {
                    options.classList.remove('show');
                    header.classList.remove('active');
                }
            } else if (selectId === 'theme-select') {
                closeSelect('quality-select');
                closeSelect('format-select');
                const isThemeSelectOpen = header.classList.contains('active');
                if (!isThemeSelectOpen) {
                    options.classList.add('show');
                    header.classList.add('active');
                } else {
                    options.classList.remove('show');
                    header.classList.remove('active');
                }
            }
        }

        /**
         * 關閉指定的下拉選單
         */
        function closeSelect(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const options = select.querySelector('.custom-select-options');
            const header = select.querySelector('.custom-select-header');
            
            if (!options || !header) return;
            
            options.classList.remove('show');
            header.classList.remove('active');
            
            if (selectId === 'quality-select') {
                isQualitySelectOpen = false;
            } else if (selectId === 'format-select') {
                isFormatSelectOpen = false;
            }
        }

        /**
         * 選擇下拉選單選項
         */
        function selectOption(selectId, value, text) {
            const select = document.getElementById(selectId);
            const headerText = select.querySelector('.custom-select-text');
            const options = select.querySelectorAll('.custom-select-option');
            
            // 移除所有選項的選中狀態
            options.forEach(option => option.classList.remove('selected'));
            
            // 為當前選擇的選項添加選中狀態
            const selectedOption = Array.from(options).find(option => 
                option.textContent === text
            );
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            headerText.textContent = text;
            
            if (selectId === 'quality-select') {
                currentQuality = value;
                closeSelect('quality-select');
            } else if (selectId === 'format-select') {
                currentFormat = value;
                closeSelect('format-select');
                onFormatChange();
            }
        }

        /**
         * 處理影片格式選擇的變更。
         * 根據選擇的影片或音訊格式調整畫質選項。
         */
        function onFormatChange() {
            const qualityOptions = document.getElementById('quality-options');
            const qualityLabel = document.getElementById('video-modal-quality-label');
            const audioTypes = ["mp3", "aac", "flac", "wav"];

            if (audioTypes.includes(currentFormat)) {
                // 如果是音訊格式，顯示音訊品質
                qualityOptions.innerHTML = '';
                AUDIO_QUALITIES.forEach(q => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-select-option';
                    optionDiv.textContent = q.label;
                    optionDiv.onclick = () => selectOption('quality-select', q.value, q.label);
                    // 設定預設選中192kbps
                    if (q.value === "192") {
                        optionDiv.classList.add('selected');
                    }
                    qualityOptions.appendChild(optionDiv);
                });
                currentQuality = "192"; // 預設音訊品質
                const qualitySelectText = document.querySelector('#quality-select .custom-select-text');
                if (qualitySelectText) {
                    qualitySelectText.textContent = "192kbps";
                }
                qualityLabel.innerText = "位元率";
            } else {
                // 如果是影片格式，從 lastVideoInfo 還原影片畫質
                if (lastVideoInfo && lastVideoInfo.qualities) {
                    qualityOptions.innerHTML = '';
                    let sortedQualities = sortQualities(lastVideoInfo.qualities);
                    // 過濾掉低於360p的畫質選項
                    sortedQualities = sortedQualities.filter(q => {
                        function getValue(q) {
                            if (q.label.endsWith('K')) return parseInt(q.label) * 1000;
                            var m = q.label.match(/(\d+)p/);
                            return m ? parseInt(m[1]) : 0;
                        }
                        return getValue(q) >= 360;
                    });
                    let defaultSet = false;
                    sortedQualities.forEach(q => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'custom-select-option';
                        optionDiv.textContent = q.label + (q.ratio ? ' ' + q.ratio : '');
                        optionDiv.onclick = () => selectOption('quality-select', q.label, q.label + (q.ratio ? ' ' + q.ratio : ''));
                        // 設定預設選中1080p，如果沒有1080p則選第一個
                        if (q.label === "1080p" || (!defaultSet && sortedQualities.indexOf(q) === 0)) {
                            optionDiv.classList.add('selected');
                            currentQuality = q.label;
                            const qualitySelectText = document.querySelector('#quality-select .custom-select-text');
                            if (qualitySelectText) {
                                qualitySelectText.textContent = q.label + (q.ratio ? ' ' + q.ratio : '');
                            }
                            defaultSet = true;
                        }
                        qualityOptions.appendChild(optionDiv);
                    });
                }
                qualityLabel.innerText = "影片畫質";
            }
        }

        /**
         * 確認並開始影片下載。
         * 使用選定的選項呼叫 Python API。
         */
        function __getBackendApi() {
            // Qt WebChannel: window.api
            // 其他容器相容：window.pywebview.api
            try {
                if (window.api) return window.api;
                if (window.pywebview && window.pywebview.api) return window.pywebview.api;
            } catch(e) {}
            return null;
        }

        async function confirmDownload() {
            try {
                console.log('[confirmDownload] 開始執行');
                
                // 優先使用 showVideoModal 記錄的 currentUrl；若空才讀主頁輸入框
                let url = (currentUrl || '').trim();
                if (!url) {
                    const urlInput = document.getElementById('video-url');
                    url = (urlInput && urlInput.value ? urlInput.value.trim() : '');
                }
                const quality = currentQuality;
                const format = currentFormat;
                
                console.log('[confirmDownload] URL:', url, 'Quality:', quality, 'Format:', format);

                if (typeof closeVideoModal === 'function') {
                    closeVideoModal(); // 關閉影片選擇模態視窗
                } else {
                    console.warn('[confirmDownload] closeVideoModal 未定義');
                }

                // 先檢查文件是否存在，再決定是否加入佇列
                const backend = __getBackendApi();
                if (!backend) {
                    console.error("[confirmDownload] 找不到後端 API");
                    if (typeof showModal === 'function') {
                        showModal('錯誤', '後端 API 尚未就緒，請稍後再試');
                    } else {
                        console.error("[confirmDownload] showModal 未定義");
                        alert('錯誤：後端 API 尚未就緒，請稍後再試');
                    }
                    return;
                }

                // 檢查文件是否存在
                try {
                    console.log('[confirmDownload] 開始檢查文件是否存在');
                    const checkResult = await backend.check_file_exists_before_download(url, quality, format, format);
                    console.log("[confirmDownload] 文件存在檢查結果:", checkResult);
                    
                    if (checkResult && checkResult.startsWith('FILE_EXISTS:')) {
                        // 文件已存在，詢問用戶是否下載
                        const existingFile = checkResult.substring('FILE_EXISTS:'.length);
                        const fileName = existingFile.split(/[/\\]/).pop();
                        console.log("[confirmDownload] 文件已存在:", fileName);
                        
                        if (typeof showConfirmModal !== 'function') {
                            console.error("[confirmDownload] showConfirmModal 未定義");
                            alert('錯誤：showConfirmModal 函數未定義');
                            return;
                        }
                        
                        showConfirmModal(
                            '文件已存在',
                            '目標資料夾中已存在同名文件：<br><strong>' + fileName + '</strong><br><br>是否要刪除舊文件並重新下載？',
                            () => {
                                console.log("[confirmDownload] 用戶確認重新下載");
                                const backend2 = __getBackendApi();
                                if (!backend2 || typeof backend2.delete_existing_file !== 'function') {
                                    if (typeof showModal === 'function') showModal('錯誤', '後端不支援刪除檔案');
                                    if (typeof closeConfirmModal === 'function') closeConfirmModal();
                                    return;
                                }
                                // 1) 先刪除舊影片
                                backend2.delete_existing_file(existingFile)
                                    .then(deleteResult => {
                                        if (deleteResult !== 'OK') {
                                            if (typeof showModal === 'function') showModal('錯誤', deleteResult || '刪除舊檔案失敗');
                                            if (typeof closeConfirmModal === 'function') closeConfirmModal();
                                            return;
                                        }
                                        // 2) 將任務加入佇列（addDownloadTask 內會 showPage('queue')，即跳轉至佇列）
                                        const taskId = nextTaskId++;
                                        if (typeof addDownloadTask !== 'function') {
                                            if (typeof showModal === 'function') showModal('錯誤', 'addDownloadTask 未定義');
                                            if (typeof closeConfirmModal === 'function') closeConfirmModal();
                                            return;
                                        }
                                        addDownloadTask({
                                            id: taskId,
                                            url: url,
                                            title: lastVideoInfo.title || '未知影片',
                                            thumbnail: lastVideoInfo.thumb || '',
                                            uploader: lastVideoInfo.uploader || '未知作者',
                                            duration: lastVideoInfo.duration || '00:00',
                                            quality: quality,
                                            format: format,
                                            progress: 0,
                                            status: '等待中',
                                            filePath: '',
                                            eta: ''
                                        });
                                        try { const urlInput = document.getElementById('video-url'); if (urlInput) urlInput.value = ''; } catch(e) {}
                                        currentUrl = '';
                                        if (typeof closeConfirmModal === 'function') closeConfirmModal();
                                        // 3) 開始下載（檔案已刪除，直接 start_download 即可）
                                        if (backend2.start_download) {
                                            backend2.start_download(taskId, url, quality, format)
                                                .then(result => console.log("[confirmDownload] 下載任務啟動結果:", result))
                                                .catch(error => {
                                                    console.error("[confirmDownload] 啟動下載任務時出錯:", error);
                                                    if (typeof showModal === 'function') showModal('錯誤', '啟動下載任務時發生錯誤');
                                                });
                                        }
                                    })
                                    .catch(error => {
                                        console.error("[confirmDownload] 刪除舊檔案時出錯:", error);
                                        if (typeof showModal === 'function') showModal('錯誤', '刪除舊檔案時發生錯誤：' + error);
                                        if (typeof closeConfirmModal === 'function') closeConfirmModal();
                                    });
                            }
                        );
                        // 用戶按下「否」：不加入佇列、不跳轉、不開始下載（關閉對話框即可，無需其他動作）
                        return;
                    }
                } catch (error) {
                    console.error("[confirmDownload] 檢查文件是否存在時出錯:", error);
                    console.error("[confirmDownload] 錯誤堆棧:", error.stack);
                    // 出錯時假設文件不存在，繼續下載流程
                }

                // 文件不存在，直接將任務加入佇列並開始下載
                console.log("[confirmDownload] 文件不存在，開始下載");
                const taskId = nextTaskId++;
                console.log("[confirmDownload] 創建任務 ID:", taskId);
                
                if (typeof addDownloadTask !== 'function') {
                    console.error("[confirmDownload] addDownloadTask 未定義");
                    alert('錯誤：addDownloadTask 函數未定義');
                    return;
                }
                
                addDownloadTask({
                    id: taskId,
                    url: url,
                    title: lastVideoInfo.title || '未知影片',
                    thumbnail: lastVideoInfo.thumb || '',
                    uploader: lastVideoInfo.uploader || '未知作者',
                    duration: lastVideoInfo.duration || '00:00',
                    quality: quality,
                    format: format,
                    progress: 0,
                    status: '等待中',
                    filePath: '',
                    eta: ''
                });

                // 清理輸入狀態
                try { const urlInput = document.getElementById('video-url'); if (urlInput) urlInput.value = ''; } catch(e) { console.error("[confirmDownload] 清理輸入狀態時出錯:", e); }
                currentUrl = '';

                // 開始下載
                setTimeout(() => {
                    try {
                        const backend2 = __getBackendApi();
                        if (!backend2 || !backend2.start_download) {
                            console.error("[confirmDownload] 找不到後端 API（start_download）");
                            if (typeof showModal === 'function') {
                                showModal('錯誤', '後端 API 尚未就緒，請稍後再試');
                            }
                            return;
                        }
                        backend2.start_download(taskId, url, quality, format)
                            .then(result => {
                                console.log("[confirmDownload] 下載任務啟動結果:", result);
                            })
                            .catch(error => {
                                console.error("[confirmDownload] 啟動下載任務時出錯:", error);
                                if (typeof showModal === 'function') {
                                    showModal('錯誤', '啟動下載任務時發生錯誤');
                                }
                            });
                    } catch (e) {
                        console.error("[confirmDownload] 排程下載任務時出錯:", e);
                        console.error("[confirmDownload] 錯誤堆棧:", e.stack);
                    }
                }, 0);
            } catch (error) {
                console.error("[confirmDownload] 函數執行出錯:", error);
                console.error("[confirmDownload] 錯誤堆棧:", error.stack);
                if (typeof showModal === 'function') {
                    showModal('錯誤', '下載確認時發生錯誤：' + error.message);
                } else {
                    alert('錯誤：下載確認時發生錯誤：' + error.message);
                }
            }
        }

        /**
         * 將一個下載任務添加到佇列並更新顯示。
         * @param {Object} task - 下載任務物件。
         */
        function addDownloadTask(task) {
            downloadQueue.unshift(task); // 新增到佇列最上方
            renderQueue(); // 重新渲染整個佇列
            // 如果在主頁添加任務，切換到佇列頁面
            showPage('queue');
        }

        /**
         * 渲染或更新下載佇列的顯示。
         */
        function renderQueue() {
            const queueList = document.getElementById('queue-list');
            queueList.innerHTML = ''; // 清空現有內容以重新渲染

            if (downloadQueue.length === 0) {
                queueList.innerHTML = `<p style="text-align: center; color: #888; font-size: 18px; margin-top: 50px;">目前沒有下載任務。</p>`;
                return;
            }

            // 對佇列進行排序：
            // 1. 正在下載的排在最上方（按 id 降序，新的在上）
            // 2. 下載完畢的排在正在下載的下方（按 id 降序）
            // 3. 等待中的排在最下方（按 id 降序）
            const sortedQueue = [...downloadQueue].sort((a, b) => {
                // 定義狀態優先級：下載中 > 已完成 > 等待中
                const statusPriority = {
                    '下載中': 3,
                    '已完成': 2,
                    '等待中': 1
                };
                const priorityA = statusPriority[a.status] || 0;
                const priorityB = statusPriority[b.status] || 0;
                
                // 先按狀態優先級排序
                if (priorityA !== priorityB) {
                    return priorityB - priorityA; // 優先級高的在前
                }
                
                // 相同狀態時，按 id 降序排序（新的在上）
                return b.id - a.id;
            });

            sortedQueue.forEach((task, index) => {
                // 創建任務項目
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('queue-item');
                itemDiv.setAttribute('data-task-id', task.id); // 便於後續更新特定任務

                // 處理長網址顯示
                const displayUrl = task.url.length > 50 ? task.url.substring(0, 47) + '...' : task.url;

                let thumbnailContent;
                if (task.thumbnail) {
                    const escThumb = String(task.thumbnail).replace(/\"/g, '&quot;');
                    thumbnailContent = `<img class=\"queue-item-thumbnail-image\" src=\"${escThumb}\" alt=\"影片縮圖\" onerror=\"this.style.display='none';this.parentNode.innerHTML='<div class=\\'queue-item-thumbnail-text\\'>找不到縮圖</div>'\">`;
                } else {
                    thumbnailContent = `<div class=\"queue-item-thumbnail-text\">找不到縮圖</div>`;
                }

                // 判斷是否為已完成狀態
                const isCompleted = task.status === '已完成';
                
                // 為已完成任務添加 completed 類
                if (isCompleted) {
                    itemDiv.classList.add('completed');
                }
                
                // 根據狀態決定顯示內容
                let progressContent = '';
                if (isCompleted) {
                    // 下載完畢：不顯示進度條，改用醒目標示
                    progressContent = `
                        <div class="completed-badge">下載完成</div>
                    `;
                } else {
                    // 未完成：顯示進度條
                    progressContent = `
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${task.progress}%;"></div>
                        </div>
                        <div class="progress-text">${task.status} (${task.progress.toFixed(1)}%)</div>
                    `;
                }

                itemDiv.innerHTML = `
                    <div class="queue-item-thumbnail">
                        ${thumbnailContent}
                    </div>
                    <div class="queue-item-info">
                        <div class="queue-item-title">${task.title}</div>
                        <div class="queue-item-meta">${task.uploader} · ${task.duration} · ${task.quality} · ${task.format.toUpperCase()}</div>
                        <div class="queue-item-url">
                            <a href="${task.url}" class="queue-item-link" data-url="${task.url}" title="${task.url}">
                                ${displayUrl}
                            </a>
                        </div>
                        ${progressContent}
                    </div>
                    <div class="queue-item-actions">
                        <button class="queue-item-action-btn" onclick="openFileLocation(${task.id})" ${isCompleted ? '' : 'disabled'}>
                            <img src="assets/folder.png" alt="開啟檔案位置">
                        </button>
                    </div>
                `;
                queueList.appendChild(itemDiv);

                // 為連結添加點擊事件處理器
                const linkElement = itemDiv.querySelector('.queue-item-link');
                if (linkElement) {
                    linkElement.addEventListener('click', function(ev) {
                        ev.preventDefault();
                        ev.stopPropagation();
                        const url = this.getAttribute('data-url') || this.getAttribute('href');
                        if (url) {
                            try {
                                if (window.api && window.api.open_external_link) {
                                    window.api.open_external_link(url);
                                } else {
                                    // 備用方案
                                    console.warn('window.api.open_external_link 不可用，嘗試使用 window.open');
                                    window.open(url, '_blank');
                                }
                            } catch(e) {
                                console.error('無法開啟外部連結:', e);
                                // 最後的備用方案
                                try {
                                    window.open(url, '_blank');
                                } catch(_) {
                                    console.error('window.open 也失敗了');
                                }
                            }
                        }
                    });
                }

                // 如果不是最後一個項目，添加分隔線
                if (index < sortedQueue.length - 1) {
                    const separatorDiv = document.createElement('div');
                    separatorDiv.classList.add('queue-separator');
                    queueList.appendChild(separatorDiv);
                }
            });
        }

        // **重要：新增一個函數來更新特定任務的進度**
        // 這個函數將由 Python 後端呼叫（透過 pywebview.api.update_progress）
        // 使用格式標籤來避免同名文件不同格式時抓錯狀態
        window.updateDownloadProgress = function(taskId, progress, status = '下載中', message = '', filePath = '', format = '') {
            // 嚴格使用 taskId 來查找任務
            let taskIndex = downloadQueue.findIndex(task => task.id === taskId);
            
            // 如果找到了任務，驗證格式是否匹配（如果提供了 format）
            if (taskIndex !== -1 && format) {
                const task = downloadQueue[taskIndex];
                // 如果格式不匹配，說明可能找錯了任務，不更新
                if (task.format.toLowerCase() !== format.toLowerCase()) {
                    console.warn(`任務 ${taskId} 格式不匹配：任務格式為 ${task.format}，但後端傳遞的格式為 ${format}，跳過更新以避免錯誤更新其他任務`);
                    console.warn(`任務詳情：ID=${task.id}, URL=${task.url}, 格式=${task.format}, 狀態=${task.status}`);
                    // 嘗試通過 URL + 格式來查找正確的任務
                    const correctTask = downloadQueue.find(t => 
                        t.url === task.url && 
                        t.format.toLowerCase() === format.toLowerCase() &&
                        t.id !== taskId
                    );
                    if (correctTask) {
                        console.log(`找到正確的任務：ID=${correctTask.id}, 格式=${correctTask.format}`);
                        taskIndex = downloadQueue.indexOf(correctTask);
                    } else {
                        return; // 不更新，避免錯誤更新其他任務
                    }
                }
            }
            
            // 如果找不到任務，記錄警告但不更新
            if (taskIndex === -1) {
                console.warn(`找不到任務 ID ${taskId}，跳過進度更新`);
                return;
            }
            
            if (taskIndex !== -1) {
                const task = downloadQueue[taskIndex];
                const oldStatus = task.status;
                
                // 如果任務已經完成，不應該再更新（避免已完成任務被重置）
                if (oldStatus === '已完成' && status !== '已完成') {
                    console.warn(`任務 ${taskId} (格式: ${task.format}) 已經完成，不應該更新為 ${status}，跳過更新以避免錯誤更新`);
                    return;
                }
                
                // 更新任務狀態
                task.progress = progress;
                task.status = status;
                // 保存 ETA 信息（如果 message 包含）
                if (message) {
                    task.eta = message;
                }
                if (filePath) {
                    task.filePath = filePath; // 更新檔案路徑
                }
                
                // 如果狀態改變（特別是從下載中變為已完成），需要重新排序和渲染
                if (oldStatus !== status) {
                    console.log(`任務 ${taskId} (格式: ${task.format}) 狀態從 "${oldStatus}" 變為 "${status}"`);
                    renderQueue(); // 重新渲染整個佇列以更新排序
                    return;
                }
                
                // 如果狀態沒變，只更新進度顯示
                const itemDiv = document.querySelector(`.queue-item[data-task-id="${taskId}"]`);
                if (itemDiv) {
                    const isCompleted = status === '已完成';
                    const progressContainer = itemDiv.querySelector('.progress-bar-container');
                    const progressBar = itemDiv.querySelector('.progress-bar');
                    const progressText = itemDiv.querySelector('.progress-text');
                    const completedBadge = itemDiv.querySelector('.completed-badge');
                    const openFolderBtn = itemDiv.querySelector('.queue-item-action-btn');
                    
                    if (isCompleted) {
                        // 如果狀態變為已完成，添加 completed 類，移除進度條，顯示完成標示
                        itemDiv.classList.add('completed');
                        if (progressContainer && progressText) {
                            progressContainer.remove();
                            progressText.remove();
                            const infoDiv = itemDiv.querySelector('.queue-item-info');
                            if (infoDiv && !completedBadge) {
                                const badge = document.createElement('div');
                                badge.classList.add('completed-badge');
                                badge.textContent = '下載完成';
                                infoDiv.appendChild(badge);
                            }
                        }
                    } else {
                        // 移除 completed 類
                        itemDiv.classList.remove('completed');
                        // 更新進度條
                        if (progressBar) {
                            progressBar.style.width = `${progress}%`;
                        }
                        if (progressText) {
                            progressText.innerText = `${status} (${progress.toFixed(1)}%)`;
                        }
                        // 移除完成標示（如果存在）
                        if (completedBadge) {
                            completedBadge.remove();
                        }
                    }
                    
                    // 更新按鈕狀態：只有狀態為"已完成"時才啟用
                    if (openFolderBtn) {
                        if (status === '已完成') {
                            openFolderBtn.disabled = false; // 啟用按鈕
                            openFolderBtn.style.opacity = '1';
                            openFolderBtn.style.cursor = 'pointer';
                        } else {
                            openFolderBtn.disabled = true; // 禁用按鈕
                            openFolderBtn.style.opacity = '0.5'; // 變灰
                            openFolderBtn.style.cursor = 'not-allowed';
                        }
                    }
                }
            }
        };

        /**
         * 開啟下載檔案所在位置。後端會立即回傳，實際開啟在背景執行，避免卡住 UI。
         * @param {number} taskId - 任務ID。
         */
        function openFileLocation(taskId) {
            /* 除錯：點擊時立即 log，若終端沒有 [DBG] open_file_location_by_task 請開 DevTools 看此訊息是否出現 */
            console.log("[DBG-Frontend] 開啟資料夾按鈕被點擊 taskId=" + taskId);
            if (window.api && window.api.log_from_js) {
                try { window.api.log_from_js("info", "[DBG-Frontend] 開啟資料夾按鈕被點擊 taskId=" + taskId); } catch (e) {}
            }
            const task = downloadQueue.find(t => t.id === taskId);
            if (!task) {
                showModal("錯誤", "找不到指定的下載任務。");
                return;
            }
            const btn = document.querySelector(`.queue-item[data-task-id="${taskId}"] .queue-item-action-btn`);
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                setTimeout(function() {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }, 1500);
            }
            if (!window.api) {
                showModal("錯誤", "API 未初始化");
                return;
            }
            window.api.open_file_location_by_task(taskId)
                .then(function(result) {
                    if (result && (result.includes("失敗") || result.includes("錯誤"))) {
                        showModal("錯誤", result);
                    }
                })
                .catch(function(error) {
                    console.error("開啟檔案位置時出錯:", error);
                    showModal("錯誤", "無法開啟檔案位置。");
                });
        }





        // 點擊外部關閉下拉選單
        document.addEventListener('click', function(event) {
            const qualitySelect = document.getElementById('quality-select');
            const formatSelect = document.getElementById('format-select');
            
            // 只有在影片選擇模態視窗才處理畫質和格式選擇的關閉
            const videoModal = document.getElementById('video-modal-bg');
            if (videoModal && videoModal.classList.contains('show')) {
                if (qualitySelect && !qualitySelect.contains(event.target)) {
                    closeSelect('quality-select');
                }
                if (formatSelect && !formatSelect.contains(event.target)) {
                    closeSelect('format-select');
                }
            }
            
            // 關閉播放清單下拉選單
            const playlistModal = document.getElementById('playlist-modal-bg');
            if (playlistModal && playlistModal.style.display !== 'none') {
                const allPlaylistSelects = document.querySelectorAll('.playlist-video-controls .custom-select');
                allPlaylistSelects.forEach(select => {
                    if (!select.contains(event.target)) {
                        const options = select.querySelector('.custom-select-options');
                        const header = select.querySelector('.custom-select-header');
                        if (options && header) {
                            options.classList.remove('show');
                            header.classList.remove('active');
                        }
                    }
                });
            }
        });

        // 禁止右鍵選單
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            return false;
        });
        
        // 禁止鍵盤快捷鍵（F12、Ctrl+Shift+I、Ctrl+U等）
        document.addEventListener('keydown', (e) => {
            // 禁止 F12（開發者工具）
            if (e.key === 'F12') {
                e.preventDefault();
                return false;
            }
            // 禁止 Ctrl+Shift+I（開發者工具）
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                e.preventDefault();
                return false;
            }
            // 禁止 Ctrl+Shift+J（開發者工具）
            if (e.ctrlKey && e.shiftKey && e.key === 'J') {
                e.preventDefault();
                return false;
            }
            // 禁止 Ctrl+U（查看原始碼）
            if (e.ctrlKey && e.key === 'U') {
                e.preventDefault();
                return false;
            }
            // 禁止 Ctrl+S（儲存頁面）
            if (e.ctrlKey && e.key === 'S') {
                e.preventDefault();
                return false;
            }
        });

        // 播放清單相關變數
        let currentPlaylistData = null;
        let playlistVideosData = [];
        let playlistUseHighestQuality = false;
        let playlistGlobalFormatMode = ''; // '' | 'mp4' | 'mp3' | 'individual'
        let playlistPendingQualities = 0;   // 尚未完成畫質提取的影片數

        /**
         * 顯示播放清單選擇模態視窗
         */
        function showPlaylistModal(url, playlistInfo = null) {
            console.log('[前端] showPlaylistModal 被調用', {url, hasInfo: !!playlistInfo});
            const modal = document.getElementById('playlist-modal-bg');
            if (!modal) {
                console.error('[前端] 找不到播放清單模態視窗元素');
                showModal('錯誤', '找不到播放清單視窗元素');
                return;
            }
            
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
            
            const content = document.getElementById('playlist-modal-content');
            if (content) {
                content.innerHTML = '<div style="text-align:center;padding:40px;color:#aaa;">載入中...</div>';
            }
            
            if (playlistInfo) {
                console.log('[前端] 已有播放清單資訊，直接渲染', playlistInfo);
                try {
                    renderPlaylist(playlistInfo);
                } catch (e) {
                    console.error('[前端] 渲染播放清單時出錯:', e);
                    showModal('錯誤', '渲染播放清單時發生錯誤: ' + e.message);
                    closePlaylistModal();
                }
            } else {
                console.log('[前端] 沒有播放清單資訊，從API獲取');
                // 從API獲取播放清單資訊
                if (window.api) {
                    // 立即設置回調，確保在API返回時能正確處理
                    console.log('[前端] 立即設置播放清單專用回調函數');
                    
                    // 保存當前 URL，用於驗證回調是否對應當前請求
                    const currentPlaylistUrl = url;
                    
                    // 使用回調管理器設置專用回調
                    window.__videoInfoCallback = function(info) {
                        console.log('[前端] 收到播放清單資訊回調', info);
                        console.log('[前端] info 類型:', typeof info);
                        console.log('[前端] info.is_playlist:', info ? info.is_playlist : 'N/A');
                        console.log('[前端] 當前請求的 URL:', currentPlaylistUrl);
                        
                        try {
                            if (info && info.is_playlist) {
                                console.log('[前端] 確認是播放清單，開始渲染');
                                console.log('[前端] 播放清單標題:', info.playlist_title);
                                console.log('[前端] 播放清單影片數量:', info.video_count);
                                console.log('[前端] 播放清單影片列表:', info.videos ? info.videos.length : 0);
                                renderPlaylist(info);
                            } else {
                                console.error('[前端] 不是播放清單資訊:', info);
                                showModal('錯誤', '無法獲取播放清單資訊');
                                closePlaylistModal();
                                hideLoading(); // 關閉載入中覆蓋層
                            }
                        } catch (e) {
                            console.error('[前端] 處理播放清單資訊時出錯:', e);
                            console.error('[前端] 錯誤堆疊:', e.stack);
                            showModal('錯誤', '處理播放清單資訊時發生錯誤: ' + e.message);
                            closePlaylistModal();
                            hideLoading(); // 關閉載入中覆蓋層
                        }
                    };
                    
                    window.__videoInfoErrorCallback = function(error) {
                        console.error('[前端] 獲取播放清單資訊失敗:', error);
                        showModal('錯誤', '無法獲取播放清單資訊: ' + (error || '未知錯誤'));
                        closePlaylistModal();
                        hideLoading(); // 關閉載入中覆蓋層
                    };
                    
                    console.log('[前端] 回調設置完成');
                    console.log('[前端] window.__videoInfoCallback 是否存在:', typeof window.__videoInfoCallback === 'function');
                    console.log('[前端] window.__onVideoInfo 是否存在:', typeof window.__onVideoInfo === 'function');
                    
                    // 立即調用 API，不使用 setTimeout
                    console.log('[前端] 立即調用 API 獲取播放清單資訊');
                    try {
                        window.api.start_get_video_info(url);
                        console.log('[前端] API 調用完成（異步執行中）');
                    } catch (e) {
                        console.error('[前端] 調用 API 時出錯:', e);
                        showModal('錯誤', '調用 API 失敗: ' + e.message);
                        closePlaylistModal();
                    }
                } else {
                    console.error('[前端] API 未初始化');
                    showModal('錯誤', 'API 未初始化');
                    closePlaylistModal();
                    hideLoading(); // 關閉載入中覆蓋層
                }
            }
        }

        /**
         * 渲染播放清單
         */
        function renderPlaylist(playlistInfo) {
            console.log('[前端] renderPlaylist 開始', playlistInfo);
            try {
                if (!playlistInfo) {
                    console.error('[前端] 播放清單資訊為空');
                    showModal('錯誤', '播放清單資訊為空');
                    closePlaylistModal();
                    hideLoading(); // 關閉載入中覆蓋層
                    return;
                }
                
                currentPlaylistData = playlistInfo;
                const videos = playlistInfo.videos || [];
                console.log('[前端] 播放清單包含', videos.length, '部影片');
                
                // 預設全選下載：selected=true
                playlistVideosData = videos.map((video, idx) => {
                    console.log(`[前端] 處理影片 ${idx + 1}:`, video.title || '無標題');
                    return {
                        ...video,
                        selected: true,
                        quality: '1080p',
                        format: 'mp4',
                        qualities: null,
                        formats: null
                    };
                });

                // 更新標題
                const titleEl = document.getElementById('playlist-modal-title');
                const subtitleEl = document.getElementById('playlist-modal-subtitle');
                if (titleEl) {
                    titleEl.textContent = playlistInfo.playlist_title || '播放清單';
                }
                if (subtitleEl) {
                    subtitleEl.textContent = `共 ${playlistInfo.video_count || playlistVideosData.length || 0} 部影片`;
                }

                // 渲染影片列表
                const content = document.getElementById('playlist-modal-content');
                if (!content) {
                    console.error('[前端] 找不到播放清單內容容器');
                    showModal('錯誤', '找不到播放清單內容容器');
                    return;
                }
                
                console.log('[前端] 清空內容容器，開始渲染', playlistVideosData.length, '個項目');
                content.innerHTML = '';

                if (playlistVideosData.length === 0) {
                    content.innerHTML = '<div style="text-align:center;padding:40px;color:#aaa;">播放清單中沒有影片</div>';
                    console.log('[前端] 播放清單為空');
                    updatePlaylistSelectedCount();
                    hideLoading(); // 關閉載入中覆蓋層
                    return;
                }

                // 初始化畫質載入計數
                playlistPendingQualities = playlistVideosData.length;

                playlistVideosData.forEach((video, index) => {
                    try {
                        const item = document.createElement('div');
                        item.className = 'playlist-video-item';
                        item.dataset.index = index;
                        
                        // 轉義HTML特殊字符，防止XSS
                        const escapeHtml = (text) => {
                            if (!text) return '';
                            const div = document.createElement('div');
                            div.textContent = String(text);
                            return div.innerHTML;
                        };
                        
                        const safeTitle = escapeHtml(video.title || '無標題');
                        const safeDuration = escapeHtml(video.duration || '未知時長');
                        const safeThumb = escapeHtml(video.thumb || 'assets/icon.png');
                        const safeUploader = escapeHtml(video.uploader || playlistInfo.playlist_uploader || '未知上傳者');
                        
                        item.innerHTML = `
                            <input type="checkbox" class="playlist-video-checkbox" onchange="togglePlaylistVideo(${index})" ${video.selected ? 'checked' : ''}>
                            <img class="playlist-video-thumb" src="${safeThumb}" alt="縮圖" onerror="this.src='assets/icon.png'">
                            <div class="playlist-video-info">
                                <div class="playlist-video-title">${safeTitle}</div>
                                <div class="playlist-video-meta">${safeUploader} · ${safeDuration}</div>
                            </div>
                            <div class="playlist-video-controls">
                                <div class="playlist-video-select">
                                    <label style="display:block;font-size:11px;color:#aaa;margin-bottom:3px;" id="playlist-quality-label-${index}">${(video.format === 'mp3') ? '位元率' : '畫質'}</label>
                                    <div class="custom-select ${playlistUseHighestQuality ? 'disabled' : ''}" id="playlist-quality-${index}">
                                        <div class="custom-select-header" onclick="togglePlaylistSelect('playlist-quality-${index}', ${index}, 'quality')">
                                            <span class="custom-select-text">${(video.format === 'mp3') ? (video.quality ? (AUDIO_QUALITIES.find(q => q.value === video.quality)?.label || '192kbps') : '192kbps') : (video.quality || '1080p')}</span>
                                            <div class="custom-select-arrow"></div>
                                        </div>
                                        <div class="custom-select-options">
                                            <div class="custom-select-option ${video.quality === '1080p' ? 'selected' : ''}" onclick="selectPlaylistOption('playlist-quality-${index}', ${index}, 'quality', '1080p')">1080p</div>
                                            <div class="custom-select-option ${video.quality === '720p' ? 'selected' : ''}" onclick="selectPlaylistOption('playlist-quality-${index}', ${index}, 'quality', '720p')">720p</div>
                                            <div class="custom-select-option ${video.quality === '480p' ? 'selected' : ''}" onclick="selectPlaylistOption('playlist-quality-${index}', ${index}, 'quality', '480p')">480p</div>
                                            <div class="custom-select-option ${video.quality === '360p' ? 'selected' : ''}" onclick="selectPlaylistOption('playlist-quality-${index}', ${index}, 'quality', '360p')">360p</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="playlist-video-select">
                                    <label style="display:block;font-size:11px;color:#aaa;margin-bottom:3px;">格式</label>
                                    <div class="custom-select ${playlistGlobalFormatMode && playlistGlobalFormatMode !== 'individual' ? 'disabled' : ''}" id="playlist-format-${index}">
                                        <div class="custom-select-header" onclick="togglePlaylistSelect('playlist-format-${index}', ${index}, 'format')">
                                            <span class="custom-select-text">${(video.format === 'mp3') ? '音訊(mp3)' : '影片(mp4)'}</span>
                                            <div class="custom-select-arrow"></div>
                                        </div>
                                        <div class="custom-select-options">
                                            <div class="custom-select-option ${video.format === 'mp4' ? 'selected' : ''}" onclick="selectPlaylistOption('playlist-format-${index}', ${index}, 'format', 'mp4')">影片(mp4)</div>
                                            <div class="custom-select-option ${video.format === 'mp3' ? 'selected' : ''}" onclick="selectPlaylistOption('playlist-format-${index}', ${index}, 'format', 'mp3')">音訊(mp3)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        content.appendChild(item);
                        console.log(`[前端] 影片 ${index + 1} 渲染完成`);
                    } catch (e) {
                        console.error(`[前端] 渲染影片 ${index + 1} 時出錯:`, e);
                    }
                });

                console.log('[前端] 所有影片渲染完成，更新選擇計數');
                updatePlaylistSelectedCount();
                syncPlaylistToolbarState();
                updatePlaylistControlsLockState();
                console.log('[前端] renderPlaylist 完成，開始 eager 畫質提取');

                // eager：背景逐支提取每部影片的畫質選項（與單支下載邏輯一致）。
                // 注意：在全部畫質載入完成前不要關閉「載入中」遮罩。
                try {
                    const backend = __getBackendApi();
                    if (backend && backend.start_playlist_qualities_fetch) {
                        const payload = playlistVideosData.map((v, idx) => ({ index: idx, url: v.url }));
                        backend.start_playlist_qualities_fetch(JSON.stringify(payload))
                            .then((res) => { console.log('[播放清單] start_playlist_qualities_fetch:', res); })
                            .catch((e) => { console.error('[播放清單] start_playlist_qualities_fetch error:', e); });
                    } else {
                        // 後端不支援時，直接關閉載入中遮罩
                        playlistPendingQualities = 0;
                        hideLoading();
                    }
                } catch (e) {
                    console.error('[播放清單] eager 畫質提取啟動失敗:', e);
                    playlistPendingQualities = 0;
                    hideLoading();
                }
            } catch (e) {
                console.error('[前端] renderPlaylist 發生錯誤:', e);
                showModal('錯誤', '渲染播放清單時發生錯誤: ' + e.message);
                closePlaylistModal();
                hideLoading(); // 發生錯誤時也要關閉載入中覆蓋層
            }
        }

        // 後端逐支回推播放清單單一影片的畫質選項
        window.__onPlaylistVideoQualities = function(index, qualities) {
            try {
                const idx = Number(index);
                if (!Number.isFinite(idx) || !playlistVideosData[idx]) return;
                if (!Array.isArray(qualities)) qualities = [];
                const video = playlistVideosData[idx];
                video.qualities = qualities;

                // 檢查當前格式，如果是音訊格式，使用 updatePlaylistVideoQualityOptions 更新
                const audioTypes = ["mp3", "aac", "flac", "wav"];
                if (audioTypes.includes(video.format)) {
                    // 音訊格式，使用專門的更新函數
                    updatePlaylistVideoQualityOptions(idx, video.format);
                    // 標記為已載入
                    if (!video._qualitiesLoaded) {
                        video._qualitiesLoaded = true;
                        if (playlistPendingQualities > 0) {
                            playlistPendingQualities--;
                            if (playlistPendingQualities <= 0) {
                                playlistPendingQualities = 0;
                                hideLoading();
                            }
                        }
                    }
                    return;
                }

                // 更新對應下拉 options（影片格式）
                const qSel = document.getElementById(`playlist-quality-${idx}`);
                const options = qSel ? qSel.querySelector('.custom-select-options') : null;
                if (!options) return;

                const sorted = sortQualities(qualities);
                // 若沒有任何可用畫質，就維持原本預設項目，但仍視為已完成載入
                if (!sorted.length) {
                    if (playlistPendingQualities > 0) {
                        playlistPendingQualities--;
                        if (playlistPendingQualities <= 0) {
                            playlistPendingQualities = 0;
                            hideLoading();
                        }
                    }
                    return;
                }

                // 若套用最高畫質已勾選，立刻套用最高並鎖定顯示
                if (playlistUseHighestQuality) {
                    const best = sorted[0]?.label;
                    if (best) playlistVideosData[idx].quality = best;
                } else {
                    // 若目前選擇不在清單中，回退到最高畫質
                    const cur = playlistVideosData[idx].quality || '';
                    const exists = sorted.some(q => (q && q.label) === cur);
                    if (!exists && sorted[0]?.label) playlistVideosData[idx].quality = sorted[0].label;
                }

                // 重建 options
                options.innerHTML = '';
                sorted.forEach(q => {
                    const label = q.label + (q.ratio ? (' ' + q.ratio) : '');
                    const div = document.createElement('div');
                    div.className = 'custom-select-option';
                    div.textContent = q.label;
                    if (q.label === playlistVideosData[idx].quality) div.classList.add('selected');
                    div.onclick = () => selectPlaylistOption(`playlist-quality-${idx}`, idx, 'quality', q.label);
                    options.appendChild(div);
                });

                // 更新 header 顯示
                const textSpan = qSel.querySelector('.custom-select-text');
                if (textSpan) textSpan.textContent = playlistVideosData[idx].quality;

                // 若套用最高畫質已開，更新鎖定狀態（確保 disabled class）
                updatePlaylistControlsLockState();

                // 標記此影片畫質已載入並更新全域計數
                if (!video._qualitiesLoaded) {
                    video._qualitiesLoaded = true;
                    if (playlistPendingQualities > 0) {
                        playlistPendingQualities--;
                        if (playlistPendingQualities <= 0) {
                            playlistPendingQualities = 0;
                            console.log('[播放清單] 所有影片畫質已載入，關閉載入中遮罩');
                            hideLoading();
                        }
                    }
                }
            } catch(e) {
                console.error('[播放清單] __onPlaylistVideoQualities failed:', e);
            }
        };

        /**
         * 切換播放清單下拉選單
         */
        function togglePlaylistSelect(selectId, index, type) {
            // 套用最高畫質：鎖定單支畫質
            if (type === 'quality' && playlistUseHighestQuality) return;
            // 全部影片格式非 individual：鎖定單支格式
            if (type === 'format' && playlistGlobalFormatMode && playlistGlobalFormatMode !== 'individual') return;
            // 檢查是否被禁用
            const select = document.getElementById(selectId);
            if (!select || select.classList.contains('disabled')) return;
            
            const options = select.querySelector('.custom-select-options');
            const header = select.querySelector('.custom-select-header');
            
            if (!options || !header) return;
            
            // 關閉其他播放清單下拉選單
            const allSelects = document.querySelectorAll('.playlist-video-controls .custom-select');
            allSelects.forEach(s => {
                if (s.id !== selectId) {
                    const opt = s.querySelector('.custom-select-options');
                    const hdr = s.querySelector('.custom-select-header');
                    if (opt && hdr) {
                        opt.classList.remove('show');
                        hdr.classList.remove('active');
                    }
                }
            });
            
            // 切換當前下拉選單
            const isOpen = options.classList.contains('show');
            if (isOpen) {
                options.classList.remove('show');
                header.classList.remove('active');
            } else {
                options.classList.add('show');
                header.classList.add('active');
            }
        }
        
        /**
         * 選擇播放清單選項
         */
        function selectPlaylistOption(selectId, index, type, value) {
            const select = document.getElementById(selectId);
            if (!select || select.classList.contains('disabled')) return;
            
            const header = select.querySelector('.custom-select-header');
            const textSpan = header ? header.querySelector('.custom-select-text') : null;
            const options = select.querySelector('.custom-select-options');
            
            // 更新顯示文字
            if (textSpan) {
                if (type === 'quality') {
                    // 檢查是否為音訊位元率，如果是則顯示完整的 label（包含 kbps）
                    const audioTypes = ["mp3", "aac", "flac", "wav"];
                    const video = playlistVideosData[index];
                    if (video && audioTypes.includes(video.format)) {
                        // 音訊格式：根據 value 找到對應的 label
                        const audioQuality = AUDIO_QUALITIES.find(q => q.value === value);
                        textSpan.textContent = audioQuality ? audioQuality.label : value;
                    } else {
                        // 影片格式：直接顯示 value
                        textSpan.textContent = value;
                    }
                } else if (type === 'format') {
                    textSpan.textContent = (value === 'mp3') ? '音訊(mp3)' : '影片(mp4)';
                }
            }
            
            // 更新選中狀態
            if (options) {
                options.querySelectorAll('.custom-select-option').forEach(opt => {
                    opt.classList.remove('selected');
                    // 根據類型匹配選項
                    if (type === 'quality' && opt.textContent.trim() === value) {
                        opt.classList.add('selected');
                    } else if (type === 'format') {
                        if ((value === 'mp4' && opt.textContent.includes('mp4')) ||
                            (value === 'mp3' && opt.textContent.includes('mp3'))) {
                            opt.classList.add('selected');
                        }
                    }
                });
            }
            
            // 關閉下拉選單
            if (options) options.classList.remove('show');
            if (header) header.classList.remove('active');
            
            // 更新數據
            if (type === 'quality') {
                updatePlaylistVideoQuality(index, value);
            } else if (type === 'format') {
                updatePlaylistVideoFormat(index, value);
                // 格式改變時，立即更新畫質選項和顯示
                updatePlaylistVideoQualityOptions(index, value);
            }
        }
        
        /**
         * 切換播放清單影片選擇狀態
         */
        function togglePlaylistVideo(index) {
            if (playlistVideosData[index]) {
                playlistVideosData[index].selected = !playlistVideosData[index].selected;
                const item = document.querySelector(`.playlist-video-item[data-index="${index}"]`);
                if (item) {
                    if (playlistVideosData[index].selected) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                }
                updatePlaylistSelectedCount();
                syncPlaylistToolbarState();
            }
        }

        /**
         * 更新播放清單影片畫質
         */
        function updatePlaylistVideoQuality(index, quality) {
            if (playlistVideosData[index]) {
                playlistVideosData[index].quality = quality;
            }
        }

        /**
         * 更新播放清單影片格式
         */
        function updatePlaylistVideoFormat(index, format) {
            if (playlistVideosData[index]) {
                playlistVideosData[index].format = format;
                // 更新畫質選項和標籤
                updatePlaylistVideoQualityOptions(index, format);
            }
        }

        /**
         * 根據格式更新播放清單項目的畫質選項
         */
        function updatePlaylistVideoQualityOptions(index, format) {
            const audioTypes = ["mp3", "aac", "flac", "wav"];
            const isAudio = audioTypes.includes(format);
            
            // 更新標籤
            const qualityLabel = document.getElementById(`playlist-quality-label-${index}`);
            if (qualityLabel) {
                qualityLabel.textContent = isAudio ? '位元率' : '畫質';
            }
            
            // 更新畫質選項
            const qSel = document.getElementById(`playlist-quality-${index}`);
            if (!qSel) return;
            
            const options = qSel.querySelector('.custom-select-options');
            const textSpan = qSel.querySelector('.custom-select-text');
            if (!options) return;
            
            const video = playlistVideosData[index];
            
            if (isAudio) {
                // 如果是音訊格式，顯示音訊位元率選項
                options.innerHTML = '';
                // 檢查當前品質是否為有效的音訊位元率
                const isValidAudioQuality = AUDIO_QUALITIES.some(q => q.value === video.quality);
                // 若套用最高畫質/位元率已勾選，使用最高位元率；否則如果當前品質是有效的音訊位元率就使用它，否則使用預設值
                const targetQuality = playlistUseHighestQuality 
                    ? AUDIO_QUALITIES[0].value 
                    : (isValidAudioQuality ? video.quality : '192');
                
                // 確保 video.quality 被設置為有效的音訊位元率
                video.quality = targetQuality;
                
                AUDIO_QUALITIES.forEach(q => {
                    const div = document.createElement('div');
                    div.className = 'custom-select-option';
                    div.textContent = q.label;
                    if (q.value === targetQuality) {
                        div.classList.add('selected');
                        if (textSpan) textSpan.textContent = q.label;
                    }
                    div.onclick = () => selectPlaylistOption(`playlist-quality-${index}`, index, 'quality', q.value);
                    options.appendChild(div);
                });
                
                // 確保顯示文字已更新
                const qualityObj = AUDIO_QUALITIES.find(q => q.value === targetQuality);
                if (textSpan && qualityObj) {
                    textSpan.textContent = qualityObj.label;
                }
            } else {
                // 如果是影片格式，顯示影片畫質選項
                // 如果有已載入的畫質選項，使用它們；否則使用預設選項
                if (video.qualities && video.qualities.length > 0) {
                    options.innerHTML = '';
                    const sorted = sortQualities(video.qualities);
                    sorted.forEach(q => {
                        const label = q.label + (q.ratio ? (' ' + q.ratio) : '');
                        const div = document.createElement('div');
                        div.className = 'custom-select-option';
                        div.textContent = q.label;
                        if (q.label === (video.quality || '1080p')) {
                            div.classList.add('selected');
                            if (textSpan) textSpan.textContent = q.label;
                        }
                        div.onclick = () => selectPlaylistOption(`playlist-quality-${index}`, index, 'quality', q.label);
                        options.appendChild(div);
                    });
                    // 如果當前品質不在清單中，設置為第一個
                    if (!sorted.some(q => q.label === video.quality) && sorted.length > 0) {
                        video.quality = sorted[0].label;
                        if (textSpan) textSpan.textContent = sorted[0].label;
                    }
                } else {
                    // 如果還沒有載入畫質，使用預設選項
                    options.innerHTML = '';
                    const defaultQualities = ['1080p', '720p', '480p', '360p'];
                    // 如果當前品質是音訊位元率，重置為預設值
                    if (!defaultQualities.includes(video.quality)) {
                        video.quality = '1080p';
                    }
                    defaultQualities.forEach(q => {
                        const div = document.createElement('div');
                        div.className = 'custom-select-option';
                        div.textContent = q;
                        if (q === (video.quality || '1080p')) {
                            div.classList.add('selected');
                            if (textSpan) textSpan.textContent = q;
                        }
                        div.onclick = () => selectPlaylistOption(`playlist-quality-${index}`, index, 'quality', q);
                        options.appendChild(div);
                    });
                }
            }
        }

        /**
         * 全選播放清單影片
         */
        function selectAllPlaylistVideos() {
            playlistVideosData.forEach((video, index) => {
                video.selected = true;
                const checkbox = document.querySelector(`.playlist-video-item[data-index="${index}"] .playlist-video-checkbox`);
                if (checkbox) checkbox.checked = true;
                const item = document.querySelector(`.playlist-video-item[data-index="${index}"]`);
                if (item) item.classList.add('selected');
            });
            updatePlaylistSelectedCount();
            syncPlaylistToolbarState();
        }

        /**
         * 取消全選播放清單影片
         */
        function deselectAllPlaylistVideos() {
            playlistVideosData.forEach((video, index) => {
                video.selected = false;
                const checkbox = document.querySelector(`.playlist-video-item[data-index="${index}"] .playlist-video-checkbox`);
                if (checkbox) checkbox.checked = false;
                const item = document.querySelector(`.playlist-video-item[data-index="${index}"]`);
                if (item) item.classList.remove('selected');
            });
            updatePlaylistSelectedCount();
            syncPlaylistToolbarState();
        }

        function onPlaylistSelectAllChanged(checked) {
            if (checked) selectAllPlaylistVideos();
            else deselectAllPlaylistVideos();
        }

        function syncPlaylistToolbarState() {
            try {
                const allCb = document.getElementById('playlist-select-all');
                if (allCb) {
                    const allSelected = playlistVideosData.length > 0 && playlistVideosData.every(v => !!v.selected);
                    const noneSelected = playlistVideosData.every(v => !v.selected);
                    allCb.indeterminate = !allSelected && !noneSelected;
                    allCb.checked = allSelected;
                }
                const hq = document.getElementById('playlist-apply-highest-quality');
                if (hq) hq.checked = !!playlistUseHighestQuality;
                const gfSel = document.getElementById('playlist-global-format-select');
                if (gfSel) {
                    const textSpan = gfSel.querySelector('.custom-select-text');
                    const label =
                        (playlistGlobalFormatMode === 'mp4') ? '影片(mp4)' :
                        (playlistGlobalFormatMode === 'mp3') ? '音訊(mp3)' :
                        (playlistGlobalFormatMode === 'individual') ? '個別選擇格式' :
                        '-請選擇影片格式-';
                    if (textSpan) textSpan.textContent = label;
                    const opts = gfSel.querySelectorAll('.custom-select-option');
                    opts.forEach(opt => {
                        const t = (opt.textContent || '').trim();
                        const selected =
                            (playlistGlobalFormatMode === 'mp4' && t.includes('mp4')) ||
                            (playlistGlobalFormatMode === 'mp3' && t.includes('mp3')) ||
                            (playlistGlobalFormatMode === 'individual' && t.includes('個別')) ||
                            (!playlistGlobalFormatMode && t.includes('-請選擇影片格式-'));
                        opt.classList.toggle('selected', !!selected);
                    });
                }
            } catch(e) {}
        }

        function togglePlaylistGlobalFormatSelect() {
            const select = document.getElementById('playlist-global-format-select');
            if (!select) return;
            const options = document.getElementById('playlist-global-format-options');
            const header = select.querySelector('.custom-select-header');
            if (!options || !header) return;

            // 關閉其他播放清單下拉選單（含單支影片的）
            try {
                document.querySelectorAll('.playlist-video-controls .custom-select-options.show').forEach(el => el.classList.remove('show'));
                document.querySelectorAll('.playlist-video-controls .custom-select-header.active').forEach(el => el.classList.remove('active'));
            } catch(e) {}

            const isOpen = options.classList.contains('show');
            if (isOpen) {
                options.classList.remove('show');
                header.classList.remove('active');
            } else {
                options.classList.add('show');
                header.classList.add('active');
            }
        }

        function selectPlaylistGlobalFormatOption(value) {
            // 關閉下拉
            try {
                const options = document.getElementById('playlist-global-format-options');
                const header = document.querySelector('#playlist-global-format-select .custom-select-header');
                if (options) options.classList.remove('show');
                if (header) header.classList.remove('active');
            } catch(e) {}

            // 移除錯誤標示（如果有的話）
            const formatSelect = document.getElementById('playlist-global-format-select');
            if (formatSelect) {
                formatSelect.classList.remove('error');
            }

            // 轉呼叫既有邏輯
            onPlaylistGlobalFormatChanged(value);
        }

        function updatePlaylistControlsLockState() {
            try {
                // 關閉所有已開啟的 options
                document.querySelectorAll('.playlist-video-controls .custom-select-options.show').forEach(el => el.classList.remove('show'));
                document.querySelectorAll('.playlist-video-controls .custom-select-header.active').forEach(el => el.classList.remove('active'));

                const lockQuality = !!playlistUseHighestQuality;
                // 當選擇"-請選擇影片格式-"時（空字串），也要鎖定格式和畫質
                const lockFormat = !!(playlistGlobalFormatMode && playlistGlobalFormatMode !== 'individual') || playlistGlobalFormatMode === '';

                playlistVideosData.forEach((_, idx) => {
                    const qSel = document.getElementById(`playlist-quality-${idx}`);
                    if (qSel) qSel.classList.toggle('disabled', lockQuality || playlistGlobalFormatMode === '');
                    const fSel = document.getElementById(`playlist-format-${idx}`);
                    if (fSel) fSel.classList.toggle('disabled', lockFormat);
                });
            } catch(e) {}
        }

        function onPlaylistApplyHighestQualityChanged(checked) {
            playlistUseHighestQuality = !!checked;
            if (playlistUseHighestQuality) {
                // 立即對已拿到 qualities 的影片套用最高畫質/位元率
                playlistVideosData.forEach((video, idx) => {
                    const audioTypes = ["mp3", "aac", "flac", "wav"];
                    const isAudio = audioTypes.includes(video.format);
                    
                    if (isAudio) {
                        // 音訊格式：套用最高位元率（320kbps）
                        const bestAudio = AUDIO_QUALITIES[0]; // 第一個就是最高的（320kbps）
                        if (bestAudio) {
                            video.quality = bestAudio.value;
                            const qSel = document.getElementById(`playlist-quality-${idx}`);
                            const textSpan = qSel ? qSel.querySelector('.custom-select-text') : null;
                            if (textSpan) textSpan.textContent = bestAudio.label;
                            const opts = qSel ? qSel.querySelectorAll('.custom-select-option') : [];
                            opts.forEach(opt => opt.classList.toggle('selected', opt.textContent.trim() === bestAudio.label));
                        }
                    } else {
                        // 影片格式：套用最高畫質
                        const qs = video.qualities;
                        if (Array.isArray(qs) && qs.length > 0) {
                            const best = sortQualities(qs)[0]?.label;
                            if (best) {
                                video.quality = best;
                                // 同步 UI（不重渲染）
                                const qSel = document.getElementById(`playlist-quality-${idx}`);
                                const textSpan = qSel ? qSel.querySelector('.custom-select-text') : null;
                                if (textSpan) textSpan.textContent = best;
                                const opts = qSel ? qSel.querySelectorAll('.custom-select-option') : [];
                                opts.forEach(opt => opt.classList.toggle('selected', opt.textContent.trim() === best));
                            }
                        }
                    }
                });
            }
            updatePlaylistControlsLockState();
            syncPlaylistToolbarState();
        }

        function onPlaylistGlobalFormatChanged(value) {
            playlistGlobalFormatMode = (value || '').trim();
            if (playlistGlobalFormatMode && playlistGlobalFormatMode !== 'individual') {
                playlistVideosData.forEach((v, idx) => {
                    v.format = playlistGlobalFormatMode;
                    // 同步 UI（不重渲染）
                    const fSel = document.getElementById(`playlist-format-${idx}`);
                    const textSpan = fSel ? fSel.querySelector('.custom-select-text') : null;
                    if (textSpan) textSpan.textContent = (playlistGlobalFormatMode === 'mp3') ? '音訊(mp3)' : '影片(mp4)';
                    const opts = fSel ? fSel.querySelectorAll('.custom-select-option') : [];
                    opts.forEach(opt => opt.classList.toggle('selected',
                        (playlistGlobalFormatMode === 'mp4' && opt.textContent.includes('mp4')) ||
                        (playlistGlobalFormatMode === 'mp3' && opt.textContent.includes('mp3'))
                    ));
                    // 更新畫質選項和標籤
                    updatePlaylistVideoQualityOptions(idx, playlistGlobalFormatMode);
                });
            }
            updatePlaylistControlsLockState();
            syncPlaylistToolbarState();
        }

        /**
         * 套用畫質到已選影片
         */
        // 已刪除：套用畫質/格式到已選（改為工具列：套用最高畫質 + 全部影片格式）

        /**
         * 更新已選擇影片數量
         */
        function updatePlaylistSelectedCount() {
            const count = playlistVideosData.filter(v => v.selected).length;
            document.getElementById('playlist-selected-count').textContent = `已選擇 ${count} 部影片`;
            document.getElementById('playlist-download-btn').disabled = count === 0;
        }

        /**
         * 開始播放清單下載
         */
        function startPlaylistDownload() {
            const selectedVideos = playlistVideosData.filter(v => v.selected);
            if (selectedVideos.length === 0) {
                showModal('錯誤', '請至少選擇一部影片');
                return;
            }

            // 檢查是否選擇了影片格式
            if (!playlistGlobalFormatMode || playlistGlobalFormatMode === '') {
                showModal('提醒', '請選擇影片格式');
                // 醒目標示影片格式下拉欄
                const formatSelect = document.getElementById('playlist-global-format-select');
                if (formatSelect) {
                    formatSelect.classList.add('error');
                    // 打開下拉選單以提醒用戶
                    const header = formatSelect.querySelector('.custom-select-header');
                    const options = document.getElementById('playlist-global-format-options');
                    if (header && options) {
                        options.classList.add('show');
                        header.classList.add('active');
                    }
                    // 3秒後移除錯誤標示
                    setTimeout(() => {
                        formatSelect.classList.remove('error');
                        if (options && header) {
                            options.classList.remove('show');
                            header.classList.remove('active');
                        }
                    }, 3000);
                }
                return;
            }

            const backend = __getBackendApi();
            if (!backend || !(backend.start_batch_download || backend.start_download)) {
                showModal('錯誤', '後端 API 尚未就緒，請稍後再試');
                return;
            }

            // 先把任務加入佇列（UI 立即可見）
            const batchPayload = [];
            selectedVideos.forEach((video) => {
                const taskId = nextTaskId++;
                const task = {
                    id: taskId,
                    url: video.url,
                    title: video.title || '未知影片',
                    thumbnail: video.thumb || '',
                    uploader: currentPlaylistData?.playlist_uploader || '未知作者',
                    duration: video.duration || '00:00',
                    quality: video.quality || '1080p',
                    format: video.format || 'mp4',
                    progress: 0,
                    status: '等待中',
                    filePath: '',
                    eta: ''
                };
                addDownloadTask(task);
                batchPayload.push({ id: taskId, url: task.url, quality: task.quality, format: task.format });
            });

            // 交給後端統一排程（比 setTimeout 多次呼叫穩定）
            try {
                if (backend.start_batch_download) {
                    backend.start_batch_download(JSON.stringify(batchPayload))
                        .then((result) => { console.log('批量下載結果:', result); })
                        .catch((e) => { console.error('批量下載失敗:', e); });
                } else {
                    // 後備：逐個啟動
                    batchPayload.forEach((it, idx) => {
                        setTimeout(() => {
                            try { backend.start_download(it.id, it.url, it.quality, it.format); } catch(_) {}
                        }, idx * 500);
                    });
                }
            } catch(e) {
                console.error('啟動批量下載時出錯:', e);
            }

            showModal('成功', `已開始下載 ${selectedVideos.length} 部影片`);
            closePlaylistModal();
            showPage('queue');
        }

        /**
         * 關閉播放清單模態視窗
         */
        function closePlaylistModal() {
            const modal = document.getElementById('playlist-modal-bg');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // 首次載入時，綁定Enter事件並顯示主頁
        document.addEventListener('DOMContentLoaded', () => {
            const homeInput = document.getElementById('video-url');
            if (homeInput) {
                homeInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        downloadVideo();
                    }
                });
            }
            const queueInput = document.getElementById('queue-video-url');
            if (queueInput) {
                queueInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        downloadVideoFromQueue();
                    }
                });
            }
            showPage('home');
        });
    </script>
</body>
</html>
